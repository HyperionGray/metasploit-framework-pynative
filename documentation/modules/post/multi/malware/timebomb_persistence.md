# Multi Platform Time-Bomb Persistence (Simulated Malware)

## Description

This module simulates malware persistence behavior by creating a backdoor that automatically self-destructs after a configurable time period. This is useful for penetration testing and red team exercises to demonstrate persistence techniques without requiring manual cleanup.

**Part of the Simulated Malware Category**: This module is designed for security testing purposes only. It includes automatic cleanup mechanisms to ensure all artifacts are removed after the configured time period.

## Module Information

- **Module Path**: `post/multi/malware/timebomb_persistence`
- **Platforms**: Windows, Linux, macOS, Unix
- **Session Types**: Meterpreter, Shell
- **License**: Metasploit Framework License (BSD)

## Module Options

### Required Options

- **EXPIRATION_HOURS** - Hours until auto-cleanup (default: 24)
  - Determines when the time bomb will trigger and remove all artifacts
  - Minimum: 1 hour, Recommended: 24-72 hours for realistic testing

- **TRIGGER** - When to execute payload (default: BOOT)
  - `BOOT` - Execute at system boot
  - `LOGIN` - Execute at user login
  - `INTERVAL` - Execute at regular intervals

### Optional Options

- **PAYLOAD_COMMAND** - Custom command/payload to execute
  - If not specified, uses a simulated payload for demonstration
  - Can be any valid shell command for the target platform

- **INTERVAL_MINUTES** - Interval in minutes for INTERVAL trigger (default: 60)
  - Only used when TRIGGER is set to INTERVAL
  - Determines how often the payload executes

- **VERBOSE** - Verbose output (default: true)
  - Shows detailed progress and diagnostic information

## How It Works

1. **Platform Detection**: Automatically detects the target platform (Windows/Linux/macOS/Unix)
2. **Script Generation**: Creates a platform-specific time-bomb script with:
   - Expiration timestamp check
   - Payload execution logic
   - Automatic cleanup routine
3. **Script Deployment**: Uploads the script to the target's temporary directory
4. **Persistence Setup**: Configures persistence using platform-appropriate mechanisms:
   - **Windows**: Registry Run keys or Scheduled Tasks
   - **Linux**: Systemd services or Cron jobs
   - **macOS**: LaunchAgents
   - **Unix**: Cron jobs
5. **Time-Bomb Activation**: Script checks expiration on each run and self-destructs when expired

## Usage Examples

### Basic Usage - Boot Persistence with 24-Hour Auto-Cleanup

```
use post/multi/malware/timebomb_persistence
set SESSION 1
set EXPIRATION_HOURS 24
set TRIGGER BOOT
run
```

### Login-Based Persistence with 48-Hour Auto-Cleanup

```
use post/multi/malware/timebomb_persistence
set SESSION 1
set EXPIRATION_HOURS 48
set TRIGGER LOGIN
run
```

### Interval-Based Execution (Every 30 Minutes) with 12-Hour Auto-Cleanup

```
use post/multi/malware/timebomb_persistence
set SESSION 1
set EXPIRATION_HOURS 12
set TRIGGER INTERVAL
set INTERVAL_MINUTES 30
run
```

### Custom Payload Command

```
use post/multi/malware/timebomb_persistence
set SESSION 1
set EXPIRATION_HOURS 24
set TRIGGER BOOT
set PAYLOAD_COMMAND "powershell.exe -Command \"Write-Host 'Custom payload executed'\""
run
```

## Example Output

```
[*] ============================================================
[*] SIMULATED MALWARE: Time-Bomb Persistence Module
[*] ============================================================
[!] This module creates artifacts that will AUTO-DELETE after 24 hours
[*] ============================================================
[*] Detected platform: windows
[+] Time-bomb script deployed: C:\Users\user\AppData\Local\Temp\SystemMaintenance.ps1
[+] Persistence established successfully
[*] Auto-cleanup scheduled for: 2025-12-15 11:07:25 +0000
[*] Artifacts will self-destruct after 24 hours
```

## Persistence Mechanisms by Platform

### Windows

1. **Registry Run Key** (BOOT/LOGIN)
   - Location: `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
   - Key Name: `SystemMaintenance`
   - Executes PowerShell script in hidden window

2. **Scheduled Task** (INTERVAL)
   - Task Name: `SystemMaintenance`
   - Executes at specified intervals
   - Runs with user privileges

### Linux

1. **Systemd Service** (BOOT/LOGIN)
   - Service: `system-maintenance.service`
   - Type: Oneshot
   - Enabled at boot

2. **Cron Job** (INTERVAL or fallback)
   - Schedule: Based on TRIGGER and INTERVAL_MINUTES
   - User-level crontab entry

### macOS

1. **LaunchAgent** (BOOT/LOGIN/INTERVAL)
   - Plist: `~/Library/LaunchAgents/com.system.maintenance.plist`
   - RunAtLoad: true
   - StartInterval: Based on INTERVAL_MINUTES

### Unix

1. **Cron Job** (All triggers)
   - User-level crontab entry
   - Schedule based on trigger type

## Cleanup Process

When the expiration time is reached, the script automatically:

1. **Removes Persistence Mechanisms**
   - Windows: Deletes Registry keys or Scheduled Tasks
   - Linux: Stops and removes Systemd services or Cron jobs
   - macOS: Unloads and removes LaunchAgents
   - Unix: Removes Cron jobs

2. **Deletes Script Files**
   - Removes the time-bomb script from disk

3. **Self-Terminates**
   - Script exits after cleanup

## Security Considerations

### For Penetration Testers

- Always inform clients about simulated malware testing
- Document all deployed modules and their expiration times
- Verify cleanup occurs after expiration
- Do not use on production systems without authorization

### For Detection

This module creates indicators that security tools may detect:

- **Artifacts on Disk**: Script files in temporary directories
- **Configuration Changes**: Registry keys, scheduled tasks, cron jobs
- **Process Execution**: PowerShell or shell script execution
- **IOCs in Logs**: System event logs may record persistence mechanisms

## Limitations

- Requires active session (Meterpreter or Shell)
- Cleanup depends on script execution - if system is offline during expiration, cleanup occurs on next execution
- Administrative/root privileges may be required for certain persistence mechanisms (e.g., Systemd services)
- Windows Defender and other AV solutions may detect and block script execution

## Scenarios

### Red Team Exercise

Demonstrate persistence techniques during a red team engagement to show:
- How attackers maintain access
- Detection gaps in the environment
- Effectiveness of EDR/AV solutions

### Penetration Test

Use during penetration testing to:
- Test persistence detection capabilities
- Demonstrate risk of unauthorized access
- Provide evidence for security recommendations

### Security Training

Educational use for:
- Teaching malware persistence techniques
- Demonstrating time-bomb/logic-bomb concepts
- Training SOC analysts on detection methods

## References

- [Metasploit Documentation](https://docs.metasploit.com/)
- [MITRE ATT&CK: Persistence Techniques](https://attack.mitre.org/tactics/TA0003/)
- [MITRE ATT&CK: T1053 - Scheduled Task/Job](https://attack.mitre.org/techniques/T1053/)
- [MITRE ATT&CK: T1547 - Boot or Logon Autostart Execution](https://attack.mitre.org/techniques/T1547/)
