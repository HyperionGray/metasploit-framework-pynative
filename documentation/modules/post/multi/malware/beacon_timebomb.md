# Multi Platform Time-Bomb Beacon (Simulated Malware)

## Description

This module simulates Command & Control (C2) beacon behavior by creating a script that periodically "beacons" back (simulated through logging) with automatic self-destruct after a configurable time period. This demonstrates realistic malware communication patterns without actually establishing C2 connections.

## Module Information

- **Module Path**: `post/multi/malware/beacon_timebomb`
- **Platforms**: Windows, Linux, macOS, Unix
- **Session Types**: Meterpreter, Shell
- **License**: Metasploit Framework License (BSD)

## Module Options

### Required Options

- **BEACON_INTERVAL** - Interval between beacons in minutes (default: 5)
  - How often the beacon script executes
  - Typical values: 1-60 minutes
  - Lower values = more traffic/logs, higher detection chance

- **EXPIRATION_HOURS** - Hours until auto-cleanup (default: 24)
  - When the beacon will stop and self-destruct
  - Recommended: 12-48 hours for realistic testing

### Optional Options

- **BEACON_TARGET** - Simulated beacon target (default: localhost)
  - Used for logging purposes only
  - No actual network traffic is generated
  - Helps simulate realistic C2 targeting

- **VERBOSE** - Verbose output (default: true)
  - Shows detailed deployment information

## How It Works

1. **Script Generation**: Creates a platform-specific beacon script that:
   - Checks current time against expiration timestamp
   - Logs "beacon" data (hostname, username, timestamp)
   - Self-destructs when expiration time is reached

2. **Script Deployment**: Uploads script to temporary directory with stealth naming:
   - Windows: `WindowsUpdate.ps1`
   - Unix/Linux/macOS: `.update_checker`

3. **Periodic Execution**: Sets up scheduled execution:
   - Windows: Scheduled Task
   - Unix/Linux/macOS: Cron job

4. **Beacon Simulation**: On each execution, script logs:
   - Current timestamp
   - System hostname
   - Current username
   - Target information

5. **Automatic Cleanup**: When expiration time is reached:
   - Removes scheduled task/cron job
   - Deletes log file
   - Deletes beacon script

## Usage Examples

### Basic Beacon with Default Settings

```
use post/multi/malware/beacon_timebomb
set SESSION 1
set EXPIRATION_HOURS 24
run
```

### High-Frequency Beacon (Aggressive)

```
use post/multi/malware/beacon_timebomb
set SESSION 1
set BEACON_INTERVAL 1
set EXPIRATION_HOURS 12
run
```

### Low-Frequency Beacon (Stealthy)

```
use post/multi/malware/beacon_timebomb
set SESSION 1
set BEACON_INTERVAL 30
set EXPIRATION_HOURS 48
run
```

### Custom Target Simulation

```
use post/multi/malware/beacon_timebomb
set SESSION 1
set BEACON_INTERVAL 5
set BEACON_TARGET c2.example.com
set EXPIRATION_HOURS 24
run
```

## Example Output

```
[*] ============================================================
[*] SIMULATED MALWARE: Time-Bomb Beacon Module
[*] ============================================================
[!] Beacon will AUTO-CLEANUP after 24 hours
[*] ============================================================
[*] Detected platform: windows
[+] Beacon script deployed: C:\Users\user\AppData\Local\Temp\WindowsUpdate.ps1
[+] Beacon activated successfully
[*] Beacon interval: 5 minutes
[*] Auto-cleanup scheduled for: 2025-12-15 11:07:25 +0000
[*] All artifacts will self-destruct after 24 hours
```

## Beacon Log Format

The module creates a log file to simulate beacon traffic:

### Windows Log (`%TEMP%\.beacon_log`)

```
[2025-12-14 11:07:25] Beacon from WORKSTATION\user to localhost
[2025-12-14 11:12:25] Beacon from WORKSTATION\user to localhost
[2025-12-14 11:17:25] Beacon from WORKSTATION\user to localhost
```

### Unix/Linux/macOS Log (`/tmp/.beacon_log`)

```
[2025-12-14 11:07:25] Beacon from user@hostname to localhost
[2025-12-14 11:12:25] Beacon from user@hostname to localhost
[2025-12-14 11:17:25] Beacon from user@hostname to localhost
```

## Scheduling Mechanisms

### Windows

**Scheduled Task**:
- Task Name: `WindowsUpdate`
- Trigger: Repeating every N minutes
- Action: Execute PowerShell script with hidden window
- User: Current user context

**Command**:
```powershell
powershell.exe -WindowStyle Hidden -ExecutionPolicy Bypass -File <script_path>
```

### Unix/Linux/macOS

**Cron Job**:
- Schedule: `*/N * * * *` (every N minutes)
- Command: Execute beacon script
- User: Current user context

**Crontab Entry**:
```
*/5 * * * * /tmp/.update_checker
```

## Use Cases

### 1. C2 Detection Testing

Test if security monitoring detects periodic callbacks:

```
use post/multi/malware/beacon_timebomb
set SESSION 1
set BEACON_INTERVAL 5
set EXPIRATION_HOURS 2
run

# Monitor:
# - SIEM alerts for periodic activity
# - Scheduled task monitoring
# - Process execution patterns
# - Log file creation
```

### 2. Scheduled Task Monitoring

Verify monitoring of scheduled task creation and execution:

```
use post/multi/malware/beacon_timebomb
set SESSION 1
set BEACON_INTERVAL 15
set EXPIRATION_HOURS 4
run

# Check for:
# - Event ID 4698 (Task created)
# - Event ID 4699 (Task executed)
# - PowerShell execution logs
```

### 3. APT Simulation

Simulate advanced persistent threat beacon behavior:

```
use post/multi/malware/beacon_timebomb
set SESSION 1
set BEACON_INTERVAL 30
set BEACON_TARGET "external-c2.attackerdomain.com"
set EXPIRATION_HOURS 48
run

# Demonstrates:
# - Low-frequency beacons (stealthy)
# - Extended persistence (48 hours)
# - External C2 targeting
```

### 4. EDR Testing

Test endpoint detection and response capabilities:

```
use post/multi/malware/beacon_timebomb
set SESSION 1
set BEACON_INTERVAL 1
set EXPIRATION_HOURS 1
run

# High frequency + short duration for:
# - Aggressive testing
# - Quick validation
# - Minimal production impact
```

## Detection Opportunities

Security tools should detect this module through:

### 1. Scheduled Task Monitoring (Windows)

**Event IDs to Monitor**:
- **4698**: A scheduled task was created
- **4699**: A scheduled task was deleted
- **4700**: A scheduled task was enabled
- **4701**: A scheduled task was disabled

**Detection Points**:
- Task name: `WindowsUpdate` (mimics legitimate name)
- Command line includes `powershell.exe -WindowStyle Hidden`
- Task runs from temporary directory
- Periodic execution pattern

### 2. Process Monitoring

**Suspicious Indicators**:
- PowerShell executing with `-WindowStyle Hidden`
- Scripts running from `%TEMP%` directory
- Periodic execution pattern (every N minutes)
- Process ancestry: Task Scheduler → PowerShell

### 3. File System Monitoring

**Files to Monitor**:
- Windows: `%TEMP%\WindowsUpdate.ps1`
- Unix: `/tmp/.update_checker`
- Log files: `%TEMP%\.beacon_log` or `/tmp/.beacon_log`

**Suspicious Patterns**:
- Hidden files (Unix systems)
- Files in temporary directories
- PowerShell scripts with system-related names

### 4. Cron/At Monitoring (Unix/Linux/macOS)

**Detection Points**:
- New crontab entries
- Jobs executing hidden scripts
- Scripts in `/tmp` directory
- Periodic execution patterns

### 5. Log Analysis

**Anomalies to Detect**:
- Log files being created/updated periodically
- Hidden log files in temporary directories
- Consistent timing patterns in file access

## Limitations

- **No Actual Network Traffic**: Beacons are simulated (logged only)
- **Requires Online System**: Cleanup needs system to be running at expiration
- **User-Level Only**: Runs with current user privileges
- **Log File Evidence**: Creates detectable log file
- **Scheduled Task/Cron Required**: Depends on system scheduling features

## Comparison to Real C2 Beacons

### Similarities (Demonstrates)

✓ Periodic execution pattern
✓ Scheduled task/cron job persistence
✓ Hidden/stealthy naming conventions
✓ User context execution
✓ Time-based behavior

### Differences (Safety Features)

✗ No actual network traffic
✗ No command execution from C2
✗ No data exfiltration
✗ Automatic self-destruct
✗ Predictable cleanup

## Advanced Scenarios

### Scenario 1: Jitter Simulation

Add randomization to make beacons less predictable (manual implementation):

```
# Deploy with base interval
use post/multi/malware/beacon_timebomb
set SESSION 1
set BEACON_INTERVAL 10
set EXPIRATION_HOURS 24
run

# Note: Real C2 often adds jitter (±10-50%) to avoid pattern detection
# This module uses fixed intervals for predictability
```

### Scenario 2: Multiple Beacons

Simulate multiple compromised systems:

```
# System 1
use post/multi/malware/beacon_timebomb
set SESSION 1
set BEACON_INTERVAL 5
run

# System 2
use post/multi/malware/beacon_timebomb
set SESSION 2
set BEACON_INTERVAL 7
run

# System 3
use post/multi/malware/beacon_timebomb
set SESSION 3
set BEACON_INTERVAL 10
run

# Tests: Correlation of multiple beacon sources
```

### Scenario 3: Long-Term APT

Simulate long-term compromise:

```
use post/multi/malware/beacon_timebomb
set SESSION 1
set BEACON_INTERVAL 60
set EXPIRATION_HOURS 72
run

# Characteristics:
# - Low frequency (once per hour)
# - Long persistence (3 days)
# - Stealthy behavior
```

## Manual Cleanup

If automatic cleanup fails:

### Windows

```powershell
# Remove scheduled task
schtasks /Delete /TN WindowsUpdate /F

# Remove files
del /F /Q %TEMP%\WindowsUpdate.ps1
del /F /Q %TEMP%\.beacon_log
```

### Unix/Linux/macOS

```bash
# Remove cron job
crontab -l | grep -v ".update_checker" | crontab -

# Remove files
rm -f /tmp/.update_checker
rm -f /tmp/.beacon_log
```

## Security Recommendations

### For Blue Team

1. **Monitor Scheduled Tasks**
   - Alert on tasks with suspicious names
   - Track task creation/deletion events
   - Analyze task command lines

2. **Process Monitoring**
   - Flag hidden PowerShell execution
   - Monitor scripts from temporary directories
   - Detect periodic process patterns

3. **File Integrity Monitoring**
   - Watch temporary directories
   - Alert on hidden files
   - Track log file creation

4. **Behavioral Analysis**
   - Detect periodic activity patterns
   - Correlate multiple indicators
   - Baseline normal scheduled tasks

### For Red Team

1. **Start Conservative**
   - Use longer intervals initially
   - Monitor for detection
   - Adjust based on environment

2. **Naming Conventions**
   - Use believable system names
   - Avoid obvious malicious names
   - Mimic legitimate services

3. **Timing**
   - Consider business hours
   - Avoid detection signatures
   - Use realistic intervals

## Reporting Template

Include in penetration test reports:

```markdown
### Beacon Module Deployment

**Module**: post/multi/malware/beacon_timebomb
**Target**: <hostname> (Session <ID>)
**Deployment Time**: <timestamp>
**Expiration**: <timestamp> (<hours> hours)
**Beacon Interval**: <minutes> minutes

#### Configuration
- Beacon Target: <target>
- Platform: <Windows/Linux/macOS>
- Persistence Method: <Scheduled Task/Cron>

#### Detection Results
- Deployment Detected: [Yes/No]
- Time to Detection: [X minutes/Not detected]
- Detection Method: [SIEM/EDR/Manual/None]
- Response Triggered: [Yes/No]

#### Cleanup Verification
- Automatic Cleanup: [Success/Failed]
- Manual Cleanup Required: [Yes/No]
- Remaining Artifacts: [None/List]

#### Recommendations
1. <Recommendation based on detection results>
2. <Recommendation based on response>
3. <Recommendation for monitoring improvements>
```

## References

- [MITRE ATT&CK: T1071 - Application Layer Protocol](https://attack.mitre.org/techniques/T1071/)
- [MITRE ATT&CK: T1053 - Scheduled Task/Job](https://attack.mitre.org/techniques/T1053/)
- [MITRE ATT&CK: T1102 - Web Service](https://attack.mitre.org/techniques/T1102/)
- [Metasploit Documentation](https://docs.metasploit.com/)
