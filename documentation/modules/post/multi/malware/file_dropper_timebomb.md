# Multi Platform Time-Bomb File Dropper (Simulated Malware)

## Description

This module simulates malware file dropping behavior by uploading a file to the target system with an automatic self-destruct mechanism. The dropped file will be automatically deleted after a configurable time period. This is part of the simulated malware category for penetration testing.

## Module Information

- **Module Path**: `post/multi/malware/file_dropper_timebomb`
- **Platforms**: Windows, Linux, macOS, Unix
- **Session Types**: Meterpreter, Shell
- **License**: Metasploit Framework License (BSD)

## Module Options

### Required Options

- **LOCAL_FILE** - Local file to upload to target
  - Must be a valid path to a file on your attacking machine
  - Examples: `/tmp/payload.exe`, `./backdoor.sh`, `C:\Tools\implant.dll`

- **EXPIRATION_HOURS** - Hours until auto-cleanup (default: 24)
  - Determines when the file will be automatically deleted
  - Minimum: 1 hour, Recommended: 24-72 hours

### Optional Options

- **REMOTE_PATH** - Remote path for dropped file
  - If blank, uses the target system's temporary directory
  - Windows example: `C:\Windows\Temp`
  - Unix example: `/var/tmp`

- **REMOTE_NAME** - Remote filename
  - If blank, uses the local filename
  - Can be used to rename the file on upload

- **EXECUTE_NOW** - Execute the file immediately after upload (default: false)
  - If true, executes the file after successful upload
  - Requires appropriate file permissions

- **EXECUTE_ARGS** - Arguments to pass when executing the file
  - Only used if EXECUTE_NOW is true
  - Platform-specific command line arguments

- **VERBOSE** - Verbose output (default: true)
  - Shows detailed progress information

## How It Works

1. **File Upload**: Reads the local file and uploads it to the target
2. **Permission Setup**: Sets executable permissions on Unix-like systems
3. **Optional Execution**: Executes the file if EXECUTE_NOW is enabled
4. **Cleanup Scheduling**: Creates a platform-specific mechanism to delete the file after expiration:
   - **Windows**: Scheduled Task
   - **Unix/Linux/macOS**: `at` command or background script

## Usage Examples

### Basic File Drop with Auto-Cleanup

```
use post/multi/malware/file_dropper_timebomb
set SESSION 1
set LOCAL_FILE /tmp/implant.exe
set EXPIRATION_HOURS 24
run
```

### Upload and Execute Immediately

```
use post/multi/malware/file_dropper_timebomb
set SESSION 1
set LOCAL_FILE /root/payload.sh
set EXPIRATION_HOURS 48
set EXECUTE_NOW true
run
```

### Custom Remote Location and Name

```
use post/multi/malware/file_dropper_timebomb
set SESSION 1
set LOCAL_FILE /tmp/backdoor.exe
set REMOTE_PATH C:\Windows\System32
set REMOTE_NAME svchost32.exe
set EXPIRATION_HOURS 12
run
```

### Execute with Arguments

```
use post/multi/malware/file_dropper_timebomb
set SESSION 1
set LOCAL_FILE /tmp/script.bat
set EXPIRATION_HOURS 24
set EXECUTE_NOW true
set EXECUTE_ARGS "-silent -install"
run
```

## Example Output

```
[*] ============================================================
[*] SIMULATED MALWARE: Time-Bomb File Dropper
[*] ============================================================
[!] Dropped file will AUTO-DELETE after 24 hours
[*] ============================================================
[*] Read 51200 bytes from /tmp/implant.exe
[*] Detected platform: windows
[+] File uploaded: C:\Users\user\AppData\Local\Temp\implant.exe (51200 bytes)
[+] Time-bomb activated
[*] Auto-cleanup scheduled for: 2025-12-15 11:07:25 +0000
[*] File will self-destruct after 24 hours
```

## Cleanup Mechanisms

### Windows

Uses Windows Task Scheduler to create a one-time task that:
- Runs at the specified expiration time
- Deletes the dropped file
- Deletes itself (the scheduled task)

**Task Details:**
- Random task name for stealth
- Executes `cmd.exe /c del /F /Q <file> && schtasks /Delete /TN <task> /F`

### Unix/Linux/macOS

Primary method uses the `at` command:
- Schedules a one-time job to delete the file
- Executes at expiration time
- No persistent configuration required

Fallback method (if `at` is unavailable):
- Creates a hidden background script
- Script sleeps until expiration time
- Deletes file and removes itself

## Use Cases

### Simulating APT Behavior

Demonstrate how advanced persistent threats drop files:
```
# Drop a fake ransomware note
use post/multi/malware/file_dropper_timebomb
set SESSION 1
set LOCAL_FILE /tmp/DECRYPT_INSTRUCTIONS.txt
set REMOTE_PATH C:\Users\Public\Desktop
set REMOTE_NAME README.txt
set EXPIRATION_HOURS 1
run
```

### Testing File Monitoring Solutions

Verify that file integrity monitoring detects dropped files:
```
use post/multi/malware/file_dropper_timebomb
set SESSION 1
set LOCAL_FILE /tmp/test.exe
set REMOTE_PATH C:\Program Files
set EXPIRATION_HOURS 2
run
```

### Red Team Exercise

Simulate malware staging during a red team engagement:
```
use post/multi/malware/file_dropper_timebomb
set SESSION 1
set LOCAL_FILE /tmp/stage2.dll
set REMOTE_PATH C:\Windows\Temp
set EXPIRATION_HOURS 72
run
```

## Detection Indicators

Security tools may detect this module through:

1. **File System Monitoring**
   - New file creation in monitored directories
   - Unauthorized file writes

2. **Task Scheduler Monitoring** (Windows)
   - New scheduled task creation
   - Tasks executing `cmd.exe` with deletion commands

3. **Process Monitoring**
   - Unusual file execution patterns
   - Background script execution on Unix systems

4. **Network Monitoring** (if uploading over network)
   - Data transfer patterns
   - File upload signatures

## Limitations

- File size limited by available memory and session bandwidth
- Cleanup requires target system to be online at expiration time
- Windows Defender may quarantine or block suspicious files
- Administrative privileges may be required for certain directories
- `at` command may not be available on all Unix systems

## Security Considerations

### For Penetration Testers

- Always get written authorization before dropping files
- Document all dropped files and their locations
- Verify cleanup occurs after expiration
- Consider AV/EDR impact on file execution
- Use unique filenames to avoid conflicts

### For Blue Teams

This module creates detectable artifacts:
- **ARTIFACTS_ON_DISK**: The dropped file
- **Windows Events**: Task Scheduler events (Event ID 4698, 4699)
- **Unix Logs**: Cron/at job logs in system logs

Detection strategies:
1. Monitor file creation in temporary directories
2. Alert on scheduled task creation
3. Track unusual process execution patterns
4. Implement file integrity monitoring

## Recommendations

### Testing Environment

- Test in isolated lab environments first
- Verify cleanup works as expected
- Document all file drops in test reports
- Use realistic but harmless payloads

### Production Testing

- Coordinate with security teams
- Use short expiration times (1-4 hours)
- Monitor for detection by security tools
- Have manual cleanup procedures ready

## References

- [Metasploit Documentation](https://docs.metasploit.com/)
- [MITRE ATT&CK: T1105 - Ingress Tool Transfer](https://attack.mitre.org/techniques/T1105/)
- [MITRE ATT&CK: T1027 - Obfuscated Files or Information](https://attack.mitre.org/techniques/T1027/)
