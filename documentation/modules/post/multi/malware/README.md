# Simulated Malware Module Documentation

This directory contains documentation for the Simulated Malware modules category in Metasploit Framework.

## What is Simulated Malware?

Simulated Malware modules are specialized post-exploitation modules designed for penetration testing and red team exercises. Unlike traditional post-exploitation modules, these modules specifically simulate realistic malware behaviors with a crucial safety feature: **automatic time-bomb cleanup**.

## Purpose

These modules serve several important purposes:

1. **Realistic Testing**: Demonstrate how actual malware operates in an environment
2. **Detection Testing**: Help organizations test their security monitoring and response capabilities
3. **Safe Persistence**: Simulate persistence techniques without leaving permanent artifacts
4. **Responsible Red Teaming**: Enable realistic attack simulations with automatic cleanup

## Key Features

### Time-Bomb Mechanism

Every module in this category includes a time-bomb feature:
- Configurable expiration time (default: 24 hours)
- Automatic cleanup of all artifacts
- Self-destruct mechanism that removes persistence
- No manual cleanup required

### Safety First

These modules prioritize safety and responsibility:
- Default behaviors are benign and for demonstration
- All actions are documented and transparent
- Cleanup is predictable and verifiable
- Designed to minimize production impact

## Available Module Documentation

1. **[timebomb_persistence.md](timebomb_persistence.md)** - Multi-platform persistence with auto-cleanup
2. **[file_dropper_timebomb.md](file_dropper_timebomb.md)** - File dropper with automatic file removal

## Quick Start

### Basic Example

```bash
# Start msfconsole
msfconsole

# Use a simulated malware module
use post/multi/malware/timebomb_persistence

# Set the session
set SESSION 1

# Configure expiration (in hours)
set EXPIRATION_HOURS 24

# Set the trigger type
set TRIGGER BOOT

# Run the module
run
```

### Verification

After deployment, verify the module is working:

```bash
# For Windows persistence check:
# - Check Registry: HKCU\Software\Microsoft\Windows\CurrentVersion\Run
# - Check Scheduled Tasks: schtasks /query /tn SystemMaintenance

# For Linux persistence check:
# - Check systemd: systemctl status system-maintenance
# - Check cron: crontab -l

# For macOS persistence check:
# - Check LaunchAgents: ls ~/Library/LaunchAgents/com.system.maintenance.plist
```

## Common Use Cases

### 1. Penetration Testing

**Scenario**: Demonstrate persistence capabilities during a penetration test

```bash
use post/multi/malware/timebomb_persistence
set SESSION 1
set EXPIRATION_HOURS 12
set TRIGGER BOOT
run
```

**Result**: Shows client how an attacker could maintain access, with automatic cleanup after 12 hours.

### 2. Red Team Exercise

**Scenario**: Simulate APT-style file dropping during a red team engagement

```bash
use post/multi/malware/file_dropper_timebomb
set SESSION 1
set LOCAL_FILE /tmp/stage2_implant.exe
set EXPIRATION_HOURS 48
set EXECUTE_NOW false
run
```

**Result**: Demonstrates file staging techniques, files automatically cleaned up after 48 hours.

### 3. Security Awareness Training

**Scenario**: Show security team how malware persistence works

```bash
use post/multi/malware/timebomb_persistence
set SESSION 1
set EXPIRATION_HOURS 2
set TRIGGER INTERVAL
set INTERVAL_MINUTES 15
set VERBOSE true
run
```

**Result**: Educational demonstration with very short expiration time, showing detection opportunities.

### 4. EDR/AV Testing

**Scenario**: Test endpoint detection and response capabilities

```bash
use post/multi/malware/file_dropper_timebomb
set SESSION 1
set LOCAL_FILE /tmp/eicar.com
set EXPIRATION_HOURS 1
set EXECUTE_NOW true
run
```

**Result**: Tests security tool detection with automatic cleanup after 1 hour.

## Best Practices

### Planning

1. **Get Authorization**: Always obtain written authorization
2. **Document Everything**: Record all deployments, times, and targets
3. **Set Appropriate Expiration**: Match to engagement duration
4. **Test First**: Verify in lab before production deployment
5. **Coordinate**: Inform security teams when deploying

### Execution

1. **Start Conservative**: Use short expiration times initially
2. **Monitor Closely**: Watch for detection by security tools
3. **Keep Sessions**: Maintain session access until cleanup verified
4. **Take Notes**: Document all observations and detections
5. **Screenshot**: Capture evidence of deployment and detection

### Cleanup

1. **Verify Automatic Cleanup**: Confirm artifacts are removed
2. **Have Manual Backup**: Be prepared to clean up manually if needed
3. **Document Results**: Include cleanup verification in reports
4. **Check Thoroughly**: Verify all persistence mechanisms are removed
5. **Communicate**: Inform stakeholders when cleanup is complete

## Expiration Time Guidelines

Choose expiration times based on engagement type:

| Engagement Type | Recommended Expiration | Rationale |
|----------------|------------------------|-----------|
| Initial Testing | 1-2 hours | Quick validation, easy monitoring |
| Daily Pentest | 12-24 hours | Covers working day, minimal risk |
| Week-long Pentest | 24-48 hours | Allows multi-day testing, still safe |
| Red Team Exercise | 48-72 hours | Realistic APT simulation |
| Extended Red Team | 72 hours maximum | Never exceed without client approval |

**Important**: Never set expiration times longer than the authorized engagement period.

## Detection Guidance

### What Should Be Detected

Security tools should detect these modules through:

1. **File System Monitoring**
   - New files in temporary directories
   - Hidden files (Unix)
   - PowerShell scripts (Windows)

2. **Registry Monitoring** (Windows)
   - HKCU\Software\Microsoft\Windows\CurrentVersion\Run changes
   - New values added to autorun locations

3. **Scheduled Task Monitoring** (Windows)
   - New task creation (Event ID 4698)
   - Task execution (Event ID 4699)
   - Tasks with suspicious names or commands

4. **Process Monitoring**
   - PowerShell with hidden window style
   - Script execution from temporary directories
   - Background process creation

5. **Configuration Changes**
   - Cron job modifications
   - Systemd service creation
   - LaunchAgent installation

### Detection Testing Checklist

- [ ] File creation detected and alerted
- [ ] Persistence mechanism detected
- [ ] Scheduled execution monitored
- [ ] Process behavior flagged as suspicious
- [ ] Cleanup activities logged
- [ ] Response procedures triggered

## Troubleshooting

### Module Fails to Deploy

**Problem**: Module reports failure during deployment

**Solutions**:
1. Check session is still active
2. Verify sufficient permissions
3. Check disk space on target
4. Review module VERBOSE output

### Cleanup Doesn't Occur

**Problem**: Artifacts remain after expiration

**Causes**:
1. Target system was offline during expiration
2. Scheduled task/cron job failed to execute
3. Permissions changed preventing cleanup
4. Script was manually deleted before cleanup

**Solutions**:
1. Wait for target system to come online
2. Manual cleanup using documented procedures
3. Review session logs for errors
4. Implement backup cleanup script

### Detection Issues

**Problem**: Security tools don't detect the module

**Analysis**:
1. May indicate gaps in security monitoring
2. Could be expected for novel techniques
3. Might need tuning of detection rules
4. Consider baseline noise vs. actual detection

## Manual Cleanup Procedures

If automatic cleanup fails, use these manual procedures:

### Windows

```powershell
# Remove Registry keys
reg delete "HKCU\Software\Microsoft\Windows\CurrentVersion\Run" /v SystemMaintenance /f

# Remove Scheduled Tasks
schtasks /Delete /TN SystemMaintenance /F
schtasks /Delete /TN WindowsUpdate /F

# Remove files
del /F /Q %TEMP%\SystemMaintenance.ps1
del /F /Q %TEMP%\WindowsUpdate.ps1
del /F /Q %TEMP%\.beacon_log
```

### Linux

```bash
# Remove systemd service
sudo systemctl stop system-maintenance.service
sudo systemctl disable system-maintenance.service
sudo rm /etc/systemd/system/system-maintenance.service
sudo systemctl daemon-reload

# Remove cron jobs
crontab -l | grep -v ".system_maintenance\|.update_checker" | crontab -

# Remove files
rm -f /tmp/.system_maintenance
rm -f /tmp/.update_checker
rm -f /tmp/.beacon_log
```

### macOS

```bash
# Remove LaunchAgent
launchctl unload ~/Library/LaunchAgents/com.system.maintenance.plist
rm ~/Library/LaunchAgents/com.system.maintenance.plist

# Remove cron jobs
crontab -l | grep -v ".system_maintenance\|.update_checker" | crontab -

# Remove files
rm -f /tmp/.system_maintenance
rm -f /tmp/.update_checker
rm -f /tmp/.beacon_log
```

## Reporting

Include in penetration test reports:

1. **Module Deployment**
   - Module name and version
   - Target system and session ID
   - Deployment timestamp
   - Configuration settings used

2. **Observations**
   - Whether deployment succeeded
   - Detection by security tools (or lack thereof)
   - Time to detection (if any)
   - Security team response

3. **Cleanup**
   - Automatic cleanup verification
   - Any manual cleanup required
   - Artifacts remaining (if any)
   - Lessons learned

4. **Recommendations**
   - Detection improvements needed
   - Response procedure enhancements
   - Monitoring gaps identified
   - Training opportunities

## Legal and Ethical Considerations

### Authorization

- Written authorization required for all deployments
- Must be within authorized scope
- Client must understand simulated malware will be used
- Document authorization in engagement letters

### Compliance

- Follow applicable laws and regulations
- Adhere to organizational policies
- Respect data privacy requirements
- Maintain client confidentiality

### Professional Standards

- Act ethically and responsibly
- Minimize impact on production systems
- Communicate clearly with stakeholders
- Document thoroughly

## Further Reading

- [Metasploit Module Development Guide](https://docs.metasploit.com/docs/development/developing-modules/)
- [MITRE ATT&CK: Persistence Techniques](https://attack.mitre.org/tactics/TA0003/)
- [PTES Technical Guidelines](http://www.pentest-standard.org/index.php/Main_Page)
- [Red Team Field Manual](https://www.amazon.com/Rtfm-Red-Team-Field-Manual/dp/1494295504)

## Support

For questions or issues:
- GitHub Issues: [metasploit-framework](https://github.com/rapid7/metasploit-framework/issues)
- Documentation: [docs.metasploit.com](https://docs.metasploit.com/)
- Community: [Metasploit Slack](https://www.metasploit.com/slack)

---

**Disclaimer**: These modules are for authorized security testing only. Unauthorized use is illegal and unethical.
