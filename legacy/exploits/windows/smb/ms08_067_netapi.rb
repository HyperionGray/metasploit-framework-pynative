##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = GreatRanking

  include Msf::Exploit::Remote::DCERPC
  include Msf::Exploit::Remote::SMB::Client
  include Msf::Exploit::Remote::SMB::Client::Authenticated
  include Msf::Exploit::Brute

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'MS08-067 Microsoft Server Service Relative Path Stack Corruption',
      'Description'    => %q{
        This module exploits a parsing flaw in the path canonicalization code of
        NetAPI32.dll through the Server Service. This vulnerability, discovered by
        the Vulnerability Research Team at Tenable Network Security, can be triggered
        by a remote unauthenticated attacker against Windows 2000/XP/2003/Vista/2008
        and Windows 7 (pre-RC). A successful attack will result in arbitrary code
        execution with System privileges. Windows services are run as System, so any
        successful exploitation will result in an attacker gaining complete control
        of the system.
      },
      'Author'         => [ 'hdm', 'Brett Moore <brett.moore[at]insomniasec.com>', 'frank2 <frank2[at]dc949.org>', 'jduck <jduck[at]metasploit.com>' ],
      'License'        => MSF_LICENSE,
      'References'     =>
        [
          [ 'CVE', '2008-4250' ],
          [ 'OSVDB', '49243' ],
          [ 'MSB', 'MS08-067' ],
          [ 'URL', 'https://docs.microsoft.com/en-us/security-updates/SecurityBulletins/2008/ms08-067' ],
          [ 'URL', 'https://www.rapid7.com/db/modules/exploit/windows/smb/ms08_067_netapi/' ]
        ],
      'DefaultOptions' =>
        {
          'EXITFUNC' => 'thread',
        },
      'Payload'        =>
        {
          'Space'    => 400,
          'BadChars' => "\x00\x0a\x0d\x5c\x5f\x2f\x2e\x40",
          'StackAdjustment' => -3500,
        },
      'Platform'       => 'win',
      'Targets'        =>
        [
          [ 'Automatic Targeting', { 'auto' => true } ],
        ],
      'DefaultTarget'  => 0,
      'DisclosureDate' => '2008-10-23'
    ))

    register_options([
      Opt::RPORT(445),
      OptString.new('SMBPIPE', [ true, "The pipe name to use", 'BROWSER' ]),
    ])
  end

  def exploit
    # This is a legacy placeholder module
    # The actual exploit implementation has been moved to Python
    print_error("This is a legacy module placeholder.")
    print_error("Please use the Python-native version of this exploit.")
    return
  end
end