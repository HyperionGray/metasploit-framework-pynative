##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

class MetasploitModule < Msf::Exploit::Remote
  Rank = GreatRanking

  include Msf::Exploit::Remote::DCERPC
  include Msf::Exploit::Remote::SMB::Client
  include Msf::Exploit::Brute

  def initialize(info = {})
    super(update_info(info,
      'Name'           => 'MS08-067 Microsoft Server Service Relative Path Stack Corruption',
      'Description'    => %q{
        This module exploits a parsing flaw in the path canonicalization code of
        NetAPI32.dll through the Server Service. This module is capable of
        bypassing NX on some operating systems and service packs. The correct
        target must be used to prevent the Server Service (along with a dozen
        others in the same process) from crashing. Windows XP targets seem to
        handle multiple successful exploitation events, but 2003 targets will
        often crash or hang on subsequent attempts. This is just the first
        version of this module, full support for NX bypass on 2003, along with
        other platforms, is still in development.
      },
      'Author'         => [ 'hdm', 'Brett Moore <brett.moore[at]insomniasec.com>' ],
      'License'        => MSF_LICENSE,
      'References'     =>
        [
          [ 'CVE', '2008-4250' ],
          [ 'OSVDB', '49243' ],
          [ 'MSB', 'MS08-067' ],
          [ 'URL', 'http://www.rapid7.com/vulndb/lookup/dcerpc-ms-netapi-netpathcanonicalize-dos' ],
          [ 'URL', 'http://www.microsoft.com/technet/security/bulletin/ms08-067.mspx' ]
        ],
      'DefaultOptions' =>
        {
          'EXITFUNC' => 'thread',
        },
      'Payload'        =>
        {
          'Space'    => 400,
          'BadChars' => "\x00\x0a\x0d\x5c\x5f\x2f\x2e",
          'StackAdjustment' => -3500,
        },
      'Platform'       => 'win',
      'Targets'        =>
        [
          [ 'Automatic Targeting', { 'auto' => true } ],
        ],
      'DefaultTarget'  => 0,
      'DisclosureDate' => '2008-10-23'
    ))

    register_options([
      Opt::RPORT(445),
      OptString.new('SMBPIPE', [ true, "The pipe name to use", 'BROWSER' ]),
    ])
  end

  def exploit
    print_status("Automatically detecting the target...")
    # This is a stub implementation for testing purposes
    print_error("This is a legacy module stub - full implementation not available")
    return
  end
end