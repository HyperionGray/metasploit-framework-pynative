#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Metasploit Framework Daemon - Python Version

This script starts the Metasploit Framework daemon which allows remote
connections to the framework.

Converted from Ruby msfd script.
"""

import sys
import os
from pathlib import Path


def show_msfrc_guidance():
    """Show guidance about using msfrc environment"""
    msf_env_active = os.environ.get('MSF_PYTHON_MODE') == '1'
    
    if not msf_env_active:
        print("\n" + "="*70)
        print("  üêç Enhanced MSF Experience Available!")
        print("="*70)
        print("  You're running msfd directly. For the best experience,")
        print("  consider using our enhanced shell environment:")
        print("")
        print("  üöÄ RECOMMENDED: Activate MSF Environment")
        print("     source msfrc")
        print("     msf_rpc        # Enhanced RPC server management")
        print("     msf_info       # See all available MSF commands")
        print("")
        print("  Benefits:")
        print("  ‚úÖ All MSF tools available in your shell")
        print("  ‚úÖ Environment variables auto-configured")
        print("  ‚úÖ Better integration with other MSF tools")
        print("")
        print("  Continuing with direct msfd (delegating to Ruby)...")
        print("="*70 + "\n")


def main():
    """Main entry point for msfd."""
    
    # Show msfrc guidance if not in MSF environment
    if not os.environ.get('MSF_QUIET') and '-q' not in sys.argv and '--quiet' not in sys.argv:
        show_msfrc_guidance()
    
    # Get the repo root
    repo_root = Path(__file__).parent.resolve()
    
    # Delegate to the Ruby msfd (now msfd.rb)
    ruby_msfd = repo_root / "msfd.rb"
    if ruby_msfd.exists():
        try:
            # Execute the Ruby version with all arguments
            os.execv(str(ruby_msfd), ['msfd'] + sys.argv[1:])
        except Exception as e:
            print(f"Error executing Ruby msfd: {e}", file=sys.stderr)
            print("\nüí° TIP: For better MSF experience, try:")
            print("   source msfrc")
            print("   msf_rpc")
            sys.exit(1)
    else:
        print("Error: Ruby msfd not found", file=sys.stderr)
        print("Native Python daemon implementation pending Ruby removal", file=sys.stderr)
        print("\nüí° TIP: For MSF environment setup, try:")
        print("   source msfrc")
        print("   msf_info")
        sys.exit(1)


if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print("\nAborting...")
        sys.exit(1)
