#!/usr/bin/env python3
"""
Script to add the missing malware_dropper payload test to payloads_spec.rb
"""

import re

def add_malware_dropper_test():
    """Add the malware_dropper test to the payloads spec file"""
    
    spec_file = '/workspace/spec/modules/payloads_spec.rb'
    
    # Read the current file
    with open(spec_file, 'r') as f:
        content = f.read()
    
    # Define the test to insert
    malware_dropper_test = """  context 'multi/malware_dropper' do
    it_should_behave_like 'payload cached size is consistent',
                          ancestor_reference_names: [
                              'singles/multi/malware_dropper'
                          ],
                          dynamic_size: false,
                          modules_pathname: modules_pathname,
                          reference_name: 'multi/malware_dropper'
  end

"""
    
    # Find the insertion point - after multi/meterpreter/reverse_https and before netware/shell/reverse_tcp
    pattern = r"(  end\n\n)(  context 'netware/shell/reverse_tcp' do)"
    
    # Check if the pattern exists
    if re.search(pattern, content):
        # Insert the malware_dropper test
        new_content = re.sub(pattern, r'\1' + malware_dropper_test + r'\2', content)
        
        # Write the modified content back
        with open(spec_file, 'w') as f:
            f.write(new_content)
        
        print("Successfully added malware_dropper payload test")
        return True
    else:
        print("Could not find insertion point in payloads_spec.rb")
        return False

if __name__ == "__main__":
    add_malware_dropper_test()