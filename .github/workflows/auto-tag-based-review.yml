name: "Tag-based Code Review"

on:
  push:
    tags:
      - 'e2eweekly'
      - 'weeklyreview'
      - 'e2e-*'
      - 'review-*'
  workflow_dispatch:
    inputs:
      review_type:
        description: 'Type of review to perform'
        required: true
        default: 'e2e'
        type: choice
        options:
          - e2e
          - weekly
          - full
      ai_model:
        description: 'AI Model to use for review'
        required: false
        default: 'gpt-5.1-codex'
        type: choice
        options:
          - gpt-5.1-codex
          - gpt-5.1
          - gpt-5
          - amazonq
          - codex
          - gemini

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: read

jobs:
  tag-based-review:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@main
        with:
          fetch-depth: 0

      - name: Determine Review Type
        id: review-type
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "type=${{ inputs.review_type }}" >> $GITHUB_OUTPUT
            echo "model=${{ inputs.ai_model }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == *"e2eweekly"* ]] || [[ "${{ github.ref }}" == *"e2e"* ]]; then
            echo "type=e2e" >> $GITHUB_OUTPUT
            echo "model=gpt-5.1-codex" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == *"weeklyreview"* ]] || [[ "${{ github.ref }}" == *"review"* ]]; then
            echo "type=weekly" >> $GITHUB_OUTPUT
            echo "model=gpt-5.1" >> $GITHUB_OUTPUT
          else
            echo "type=full" >> $GITHUB_OUTPUT
            echo "model=gpt-5.1-codex" >> $GITHUB_OUTPUT
          fi

      - name: Setup Node.js
        uses: actions/setup-node@main
        with:
          node-version: '20'
        continue-on-error: true

      - name: Setup Python
        uses: actions/setup-python@main
        with:
          python-version: '3.11'
        continue-on-error: true

      - name: E2E Review with Analysis Tools
        if: steps.review-type.outputs.type == 'e2e'
        run: |
          echo "ðŸ”„ Performing comprehensive end-to-end code review..."
          echo "===================================================="
          
          # 1. Integration Points Analysis
          echo "ðŸ”— Integration Points Analysis"
          echo "------------------------------"
          
          # Check for API endpoints
          echo "API endpoints and integrations:"
          grep -r "app\.route\|@route\|@app\." --include="*.py" . | head -10 || echo "No Flask routes found"
          grep -r "def.*api\|class.*API" --include="*.py" . | head -10 || echo "No API classes found"
          
          # Check database connections
          echo ""
          echo "Database connections:"
          grep -r "connect\|engine\|session" --include="*.py" python_framework/ lib/ | grep -i "db\|sql\|mongo" | head -10 || echo "No database connections found"
          
          # Check external service integrations
          echo ""
          echo "External service integrations:"
          grep -r "requests\.\|http\|urllib" --include="*.py" . | head -10 || echo "No HTTP requests found"
          
          # 2. User Flows Analysis
          echo ""
          echo "ðŸ‘¤ User Flows Analysis"
          echo "----------------------"
          
          # Check for authentication flows
          echo "Authentication and authorization:"
          grep -r "auth\|login\|password\|token" --include="*.py" . | head -10 || echo "No auth patterns found"
          
          # Check for error handling
          echo ""
          echo "Error handling patterns:"
          grep -r "try:\|except\|raise\|Error" --include="*.py" . | wc -l | xargs echo "Error handling blocks found:"
          
          # 3. Data Flow Analysis
          echo ""
          echo "ðŸ“Š Data Flow Analysis"
          echo "--------------------"
          
          # Check for data validation
          echo "Data validation patterns:"
          grep -r "validate\|check\|verify" --include="*.py" . | head -10 || echo "No validation patterns found"
          
          # Check for data transformations
          echo ""
          echo "Data transformation patterns:"
          grep -r "transform\|convert\|parse\|serialize" --include="*.py" . | head -10 || echo "No transformation patterns found"
          
          # 4. Performance & Reliability
          echo ""
          echo "âš¡ Performance & Reliability Analysis"
          echo "------------------------------------"
          
          # Check for async patterns
          echo "Async/await patterns:"
          grep -r "async def\|await\|asyncio" --include="*.py" . | wc -l | xargs echo "Async patterns found:"
          
          # Check for timeout handling
          echo ""
          echo "Timeout handling:"
          grep -r "timeout\|sleep\|delay" --include="*.py" . | head -5 || echo "No timeout patterns found"
          
          # Check for retry mechanisms
          echo ""
          echo "Retry mechanisms:"
          grep -r "retry\|attempt\|backoff" --include="*.py" . | head -5 || echo "No retry patterns found"
          
          # 5. Security Analysis
          echo ""
          echo "ðŸ”’ Security in E2E Context"
          echo "--------------------------"
          
          # Check for secure transmission
          echo "Secure transmission patterns:"
          grep -r "https\|ssl\|tls\|encrypt" --include="*.py" . | head -5 || echo "No secure transmission patterns found"
          
          # Check for injection vulnerabilities
          echo ""
          echo "Potential injection vulnerabilities:"
          grep -r "execute\|query\|eval\|exec" --include="*.py" . | head -5 || echo "No potential injection points found"
          
          # Run security analysis if bandit is available
          if command -v bandit &> /dev/null; then
            echo ""
            echo "Running security analysis with bandit..."
            bandit -r python_framework/ lib/ -f txt || true
          fi
          
          echo ""
          echo "ðŸ“‹ E2E Review Recommendations:"
          echo "------------------------------"
          echo "1. Ensure all API endpoints have proper error handling"
          echo "2. Implement comprehensive input validation"
          echo "3. Add timeout handling for external service calls"
          echo "4. Use HTTPS for all external communications"
          echo "5. Implement proper authentication and authorization"
          echo "6. Add retry mechanisms for critical operations"
          echo "7. Use parameterized queries to prevent SQL injection"
          echo "8. Implement proper logging for debugging E2E flows"
          
          echo ""
          echo "âœ… E2E review complete."
        continue-on-error: true

      - name: Weekly Review with Analysis Tools
        if: steps.review-type.outputs.type == 'weekly'
        run: |
          echo "ðŸ“… Performing comprehensive weekly code review..."
          echo "==============================================="
          
          # 1. Architecture & Design Analysis
          echo "ðŸ—ï¸ Architecture & Design Analysis"
          echo "---------------------------------"
          
          # Check overall system architecture
          echo "System architecture overview:"
          echo "Main directories:"
          find . -maxdepth 2 -type d -not -path "*/.*" | head -20
          
          echo ""
          echo "Design pattern usage:"
          grep -r "class.*Factory\|class.*Builder\|class.*Singleton\|class.*Observer" --include="*.py" . | head -5 || echo "No common design patterns found"
          
          # Check separation of concerns
          echo ""
          echo "Module organization:"
          find python_framework/ lib/ -name "*.py" | head -10 | xargs -I {} sh -c 'echo "{}:"; head -5 "{}" | grep -E "^class|^def" || true'
          
          # 2. Code Quality Trends
          echo ""
          echo "ðŸ“Š Code Quality Trends"
          echo "----------------------"
          
          # Check recent commits (if git is available)
          if command -v git &> /dev/null; then
            echo "Recent commit activity:"
            git log --oneline --since="1 week ago" | head -10 || echo "No recent commits found"
            
            echo ""
            echo "Files changed recently:"
            git diff --name-only HEAD~7..HEAD 2>/dev/null | head -10 || echo "No recent changes found"
          fi
          
          # Check for technical debt indicators
          echo ""
          echo "Technical debt indicators:"
          grep -r "TODO\|FIXME\|HACK\|XXX" --include="*.py" . | wc -l | xargs echo "Technical debt comments:"
          
          # 3. Testing Strategy Assessment
          echo ""
          echo "ðŸ§ª Testing Strategy Assessment"
          echo "------------------------------"
          
          # Count test files
          test_count=$(find . -name "test_*.py" -o -name "*_test.py" | wc -l)
          echo "Total test files: $test_count"
          
          # Check test coverage if pytest-cov is available
          if command -v pytest &> /dev/null; then
            echo "Running test coverage analysis..."
            pytest --cov=python_framework --cov=lib --cov-report=term-missing --tb=no -q || echo "Test coverage analysis failed"
          fi
          
          # 4. Documentation Assessment
          echo ""
          echo "ðŸ“š Documentation Assessment"
          echo "---------------------------"
          
          # Check documentation files
          docs=("README.md" "CONTRIBUTING.md" "LICENSE.md" "CHANGELOG.md" "SECURITY.md")
          for doc in "${docs[@]}"; do
            if [ -f "$doc" ]; then
              last_modified=$(stat -c %y "$doc" 2>/dev/null || stat -f %m "$doc" 2>/dev/null || echo "unknown")
              echo "âœ… $doc (last modified: $last_modified)"
            else
              echo "âŒ $doc missing"
            fi
          done
          
          # Check inline documentation
          echo ""
          echo "Inline documentation coverage:"
          python3 -c "
          import ast
          import os
          
          total_functions = 0
          documented_functions = 0
          
          for root, dirs, files in os.walk('python_framework'):
              for file in files:
                  if file.endswith('.py'):
                      try:
                          filepath = os.path.join(root, file)
                          with open(filepath, 'r') as f:
                              tree = ast.parse(f.read())
                          
                          for node in ast.walk(tree):
                              if isinstance(node, ast.FunctionDef):
                                  total_functions += 1
                                  if ast.get_docstring(node):
                                      documented_functions += 1
                      except:
                          continue
          
          if total_functions > 0:
              coverage = (documented_functions / total_functions) * 100
              print(f'Function documentation: {documented_functions}/{total_functions} ({coverage:.1f}%)')
          " || true
          
          # 5. Dependencies & Security
          echo ""
          echo "ðŸ”’ Dependencies & Security"
          echo "-------------------------"
          
          # Check requirements.txt
          if [ -f "requirements.txt" ]; then
            echo "Dependencies in requirements.txt:"
            wc -l requirements.txt | xargs echo "Total dependencies:"
            
            # Check for version pinning
            pinned=$(grep -c "==" requirements.txt || echo "0")
            echo "Pinned versions: $pinned"
          fi
          
          # Run security check if safety is available
          if command -v safety &> /dev/null; then
            echo ""
            echo "Security vulnerability check:"
            safety check --json || echo "Security check completed with warnings"
          fi
          
          # 6. Performance Analysis
          echo ""
          echo "âš¡ Performance Analysis"
          echo "----------------------"
          
          # Check for performance-related patterns
          echo "Performance-related patterns:"
          grep -r "time\.\|datetime\|performance\|benchmark" --include="*.py" . | wc -l | xargs echo "Performance-related code lines:"
          
          # Check for potential resource leaks
          echo ""
          echo "Potential resource management issues:"
          grep -r "open(\|file(\|connect(" --include="*.py" . | grep -v "with " | wc -l | xargs echo "Potential resource leaks:"
          
          echo ""
          echo "ðŸ“‹ Weekly Review Summary:"
          echo "------------------------"
          echo "1. Architecture: Review module organization and design patterns"
          echo "2. Code Quality: Monitor technical debt and code complexity"
          echo "3. Testing: Maintain and improve test coverage"
          echo "4. Documentation: Keep documentation up-to-date with changes"
          echo "5. Security: Regular dependency updates and vulnerability checks"
          echo "6. Performance: Monitor for performance regressions"
          
          echo ""
          echo "ðŸŽ¯ Action Items:"
          echo "---------------"
          echo "- Address TODO/FIXME comments"
          echo "- Improve test coverage where needed"
          echo "- Update documentation for recent changes"
          echo "- Review and update dependencies"
          echo "- Consider refactoring large or complex functions"
          
          echo ""
          echo "âœ… Weekly review complete."
        continue-on-error: true

      - name: Full Review with Analysis Tools
        if: steps.review-type.outputs.type == 'full'
        run: |
          echo "ðŸ” Performing full comprehensive code review..."
          echo "=============================================="
          
          # 1. Code Quality & Architecture
          echo "ðŸ—ï¸ Code Quality & Architecture"
          echo "------------------------------"
          
          # Check overall architecture
          echo "Project structure:"
          tree -d -L 3 . 2>/dev/null || find . -type d -not -path "*/.*" | head -20
          
          # Check for large files
          echo ""
          echo "Large files (>500 lines):"
          find . -name "*.py" -exec wc -l {} + | awk '$1 > 500 {print $1 " lines: " $2}' | sort -nr | head -10
          
          # 2. Security Analysis
          echo ""
          echo "ðŸ”’ Security Analysis"
          echo "-------------------"
          
          # Run bandit if available
          if command -v bandit &> /dev/null; then
            echo "Running security analysis with bandit..."
            bandit -r python_framework/ lib/ -f txt || true
          fi
          
          # Check for common security issues
          echo ""
          echo "Potential security issues:"
          grep -r "eval\|exec\|shell=True\|subprocess\.call" --include="*.py" . | head -5 || echo "No obvious security issues found"
          
          # 3. Performance Optimization
          echo ""
          echo "âš¡ Performance Optimization"
          echo "--------------------------"
          
          # Check for performance anti-patterns
          echo "Performance considerations:"
          grep -r "for.*in.*range(len\|while.*len(" --include="*.py" . | wc -l | xargs echo "Potential inefficient loops:"
          
          # Check for database queries in loops
          grep -r "for.*query\|while.*query" --include="*.py" . | wc -l | xargs echo "Potential N+1 query issues:"
          
          # 4. Testing Strategy
          echo ""
          echo "ðŸ§ª Testing Strategy"
          echo "------------------"
          
          # Count and analyze tests
          test_files=$(find . -name "test_*.py" -o -name "*_test.py" | wc -l)
          echo "Test files found: $test_files"
          
          # Check test coverage
          if command -v pytest &> /dev/null; then
            echo "Running comprehensive test analysis..."
            pytest --collect-only -q | tail -1 || echo "Test collection failed"
          fi
          
          # 5. Documentation Quality
          echo ""
          echo "ðŸ“š Documentation Quality"
          echo "------------------------"
          
          # Check documentation files
          docs=("README.md" "CONTRIBUTING.md" "LICENSE.md" "CHANGELOG.md" "SECURITY.md" "CODE_OF_CONDUCT.md")
          for doc in "${docs[@]}"; do
            if [ -f "$doc" ]; then
              word_count=$(wc -w < "$doc")
              echo "âœ… $doc ($word_count words)"
            else
              echo "âŒ $doc missing"
            fi
          done
          
          # 6. Best Practices Adherence
          echo ""
          echo "âœ¨ Best Practices Adherence"
          echo "--------------------------"
          
          # Check for Python best practices
          echo "Python best practices check:"
          
          # Check for proper imports
          echo "Import organization:"
          grep -r "^from.*import \*" --include="*.py" . | wc -l | xargs echo "Wildcard imports (should avoid):"
          
          # Check for proper exception handling
          echo "Exception handling:"
          grep -r "except:" --include="*.py" . | wc -l | xargs echo "Bare except clauses (should specify exception type):"
          
          # 7. E2E Integration
          echo ""
          echo "ðŸ”„ E2E Integration"
          echo "-----------------"
          
          # Check for integration points
          echo "Integration points:"
          grep -r "requests\.\|http\|api" --include="*.py" . | wc -l | xargs echo "HTTP/API integration points:"
          grep -r "database\|db\|sql" --include="*.py" . | wc -l | xargs echo "Database integration points:"
          
          # 8. API Design
          echo ""
          echo "ðŸ”Œ API Design"
          echo "-------------"
          
          # Check for API endpoints
          echo "API endpoints:"
          grep -r "@app\.route\|@route\|def.*api" --include="*.py" . | head -10 || echo "No API endpoints found"
          
          # Check for proper HTTP methods
          grep -r "methods=\|GET\|POST\|PUT\|DELETE" --include="*.py" . | wc -l | xargs echo "HTTP method definitions:"
          
          # 9. Error Handling
          echo ""
          echo "âš ï¸ Error Handling"
          echo "----------------"
          
          # Check error handling patterns
          echo "Error handling analysis:"
          try_blocks=$(grep -r "try:" --include="*.py" . | wc -l)
          except_blocks=$(grep -r "except" --include="*.py" . | wc -l)
          echo "Try blocks: $try_blocks"
          echo "Except blocks: $except_blocks"
          
          # Check for logging
          grep -r "logging\|logger\|log\." --include="*.py" . | wc -l | xargs echo "Logging statements:"
          
          # 10. Maintainability
          echo ""
          echo "ðŸ”§ Maintainability"
          echo "-----------------"
          
          # Check code complexity indicators
          echo "Maintainability metrics:"
          
          # Count functions and classes
          functions=$(grep -r "^def " --include="*.py" . | wc -l)
          classes=$(grep -r "^class " --include="*.py" . | wc -l)
          echo "Functions: $functions"
          echo "Classes: $classes"
          
          # Check for comments
          comments=$(grep -r "^[[:space:]]*#" --include="*.py" . | wc -l)
          echo "Comment lines: $comments"
          
          # Check for TODO/FIXME
          todos=$(grep -r "TODO\|FIXME\|XXX" --include="*.py" . | wc -l)
          echo "TODO/FIXME items: $todos"
          
          echo ""
          echo "ðŸ“‹ Full Review Summary:"
          echo "----------------------"
          echo "1. âœ… Architecture analysis completed"
          echo "2. âœ… Security scan performed"
          echo "3. âœ… Performance review conducted"
          echo "4. âœ… Testing strategy assessed"
          echo "5. âœ… Documentation quality checked"
          echo "6. âœ… Best practices reviewed"
          echo "7. âœ… E2E integration analyzed"
          echo "8. âœ… API design evaluated"
          echo "9. âœ… Error handling reviewed"
          echo "10. âœ… Maintainability assessed"
          
          echo ""
          echo "ðŸŽ¯ Priority Recommendations:"
          echo "----------------------------"
          echo "1. Address any security vulnerabilities found"
          echo "2. Improve test coverage where needed"
          echo "3. Add missing documentation files"
          echo "4. Refactor large files (>1000 lines)"
          echo "5. Fix bare except clauses"
          echo "6. Add proper error handling and logging"
          echo "7. Address TODO/FIXME comments"
          echo "8. Optimize performance bottlenecks"
          
          echo ""
          echo "âœ… Full comprehensive review complete."
        continue-on-error: true

      - name: Generate Review Report
        id: generate-report
        run: |
          echo "## Tag-Based Code Review Report" > /tmp/tag-review-report.md
          echo "" >> /tmp/tag-review-report.md
          echo "**Review Type:** ${{ steps.review-type.outputs.type }}" >> /tmp/tag-review-report.md
          echo "**AI Model:** ${{ steps.review-type.outputs.model }}" >> /tmp/tag-review-report.md
          echo "**Triggered by:** ${{ github.event_name }}" >> /tmp/tag-review-report.md
          echo "**Tag/Branch:** ${{ github.ref }}" >> /tmp/tag-review-report.md
          echo "**Date:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> /tmp/tag-review-report.md
          echo "" >> /tmp/tag-review-report.md
          
          # Add repository stats
          echo "### Repository Statistics:" >> /tmp/tag-review-report.md
          python_files=$(find . -name "*.py" ! -path "*/.venv/*" ! -path "*/node_modules/*" | wc -l)
          js_files=$(find . -name "*.js" ! -path "*/node_modules/*" ! -path "*/dist/*" | wc -l)
          ts_files=$(find . -name "*.ts" ! -path "*/node_modules/*" ! -path "*/dist/*" | wc -l)
          
          echo "- Python files: $python_files" >> /tmp/tag-review-report.md
          echo "- JavaScript files: $js_files" >> /tmp/tag-review-report.md
          echo "- TypeScript files: $ts_files" >> /tmp/tag-review-report.md
          
          # Add recent commits
          echo "" >> /tmp/tag-review-report.md
          echo "### Recent Changes:" >> /tmp/tag-review-report.md
          git log --oneline -10 >> /tmp/tag-review-report.md || echo "No recent commits" >> /tmp/tag-review-report.md
          
          cat /tmp/tag-review-report.md
        continue-on-error: true

      - name: Create Review Issue
        uses: actions/github-script@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            let report = '';
            try {
              report = fs.readFileSync('/tmp/tag-review-report.md', 'utf8');
            } catch (e) {
              report = 'Report generation failed';
            }
            
            const date = new Date().toISOString().split('T')[0];
            const reviewType = '${{ steps.review-type.outputs.type }}';
            const model = '${{ steps.review-type.outputs.model }}';
            const title = `${reviewType.toUpperCase()} Code Review (${model}) - ${date}`;
            
            const body = `# Tag-Based Code Review Report
            
            ${report}
            
            ## Review Configuration
            
            - **Review Type:** ${reviewType}
            - **AI Model:** ${model}
            - **Repository:** ${{ github.repository }}
            - **Branch/Tag:** ${{ github.ref }}
            - **Commit:** ${{ github.sha }}
            - **Triggered by:** ${{ github.event_name }}
            
            ## About This Review
            
            This review was triggered by a tag or manual dispatch. The review type determines the focus:
            
            - **E2E Review:** Comprehensive end-to-end testing and integration analysis
            - **Weekly Review:** Broad code quality, architecture, and trend analysis
            - **Full Review:** Complete analysis covering all aspects
            
            ## Action Items
            
            Review the findings above and:
            - [ ] Address high-priority security issues
            - [ ] Implement suggested architectural improvements
            - [ ] Add missing tests for E2E scenarios
            - [ ] Update documentation as needed
            - [ ] Plan refactoring for technical debt
            
            ---
            *This issue was automatically generated by the Tag-based Code Review workflow using ${model}.*
            `;
            
            // Check for existing issues
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['tag-review', 'automated'],
              per_page: 10
            });
            
            const recentIssue = issues.data.find(issue => {
              const createdAt = new Date(issue.created_at);
              const daysSinceCreation = (Date.now() - createdAt) / (1000 * 60 * 60 * 24);
              return daysSinceCreation < 7 && issue.title.includes(reviewType);
            });
            
            if (recentIssue) {
              console.log(`Recent ${reviewType} review issue found: #${recentIssue.number}, updating`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentIssue.number,
                body: `## Updated Review (${date})\n\n${report}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['tag-review', reviewType, 'automated', 'code-review', 'needs-review']
              });
            }
        continue-on-error: true

      - name: Upload Review Report
        uses: actions/upload-artifact@main
        with:
          name: tag-review-report
          path: /tmp/tag-review-report.md
          retention-days: 90
        continue-on-error: true
