name: Verify

# https://docs.github.com/en/actions/using-workflows/workflow-syntax-for-github-actions#permissions
permissions:
  actions: none
  checks: none
  contents: none
  deployments: none
  id-token: none
  issues: none
  discussions: none
  packages: none
  pages: none
  pull-requests: none
  repository-projects: none
  security-events: none
  statuses: none

on:
  push:
    branches-ignore:
      - gh-pages
      - metakitty
      - weekly-dependency-updates
  pull_request:
    branches-ignore:
      - weekly-dependency-updates

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    name: Docker Build
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: docker-compose build
        run: |
          docker compose build

  python-test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60

    services:
      postgres:
        image: postgres:13
        ports: ["5432:5432"]
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: msf_test
        options: >-
          --health-cmd "pg_isready --username postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    strategy:
      fail-fast: true
      matrix:
        python:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
        os:
          - ubuntu-latest
        test_cmd:
          - 'python run_tests.py --unit --verbose'
          - 'python run_tests.py --integration --verbose'
          - 'python run_tests.py --security --verbose'
          - 'python run_tests.py --modules --verbose'

    env:
      PYTHONPATH: ${{ github.workspace }}/lib:${{ github.workspace }}/python_framework
      MSF_DATABASE_URL: postgresql://postgres:postgres@localhost:5432/msf_test

    name: ${{ matrix.os }} - Python ${{ matrix.python }} - ${{ matrix.test_cmd }}
    steps:
      - name: Install system dependencies
        run: sudo apt-get update && sudo apt-get install -y --no-install-recommends libpcap-dev graphviz postgresql-client

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '${{ matrix.python }}'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup database
        run: |
          # Create test database if it doesn't exist
          PGPASSWORD=postgres createdb -h localhost -U postgres msf_test || true
          
      - name: Create test results directory
        run: mkdir -p test-results

      - name: Run tests
        run: |
          echo "Running: ${CMD}"
          bash -c "${CMD}"
        env:
          CMD: ${{ matrix.test_cmd }}

      - name: Upload test results
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: test-results-${{ matrix.os }}-python${{ matrix.python }}
          path: test-results/

  # Legacy Ruby compatibility test (optional)
  ruby-compatibility:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    name: Ruby Compatibility Check
    if: false  # Disabled by default, enable if Ruby compatibility is needed
    
    services:
      postgres:
        image: postgres:9.6
        ports: ["5432:5432"]
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        options: >-
          --health-cmd "pg_isready --username postgres"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Install system dependencies
        run: sudo apt-get install -y --no-install-recommends libpcap-dev graphviz

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Create database
        run: |
          cp config/database.yml.github_actions config/database.yml
          bundle exec rake db:create
          bundle exec rake db:migrate

      - name: Run Ruby compatibility tests
        run: |
          python run_tests.py --compatibility --verbose
