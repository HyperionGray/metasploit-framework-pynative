name: "Comprehensive Test Review with Playwright"

# REQUIREMENTS:
# - A GitHub Personal Access Token with Copilot access must be created and stored as a repository secret named COPILOT_TOKEN
# - See COPILOT_TOKEN_SETUP.md for detailed setup instructions

on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  test-review-and-execution:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        mode: [headed, headless]
    steps:
      - name: Checkout code
        uses: actions/checkout@main

      - name: Setup Node.js
        uses: actions/setup-node@main
        with:
          node-version: '20'
          cache: 'npm'
        continue-on-error: true

      - name: Setup Python
        uses: actions/setup-python@main
        with:
          python-version: '3.11'
          cache: 'pip'
        continue-on-error: true

      - name: Install Node.js dependencies
        run: |
          if [ -f "package.json" ]; then
            npm install
            npm install -D @playwright/test playwright
          fi
        continue-on-error: true

      - name: Install Python dependencies
        run: |
          if [ -f "requirements.txt" ]; then
            pip install -r requirements.txt
          fi
          pip install pytest playwright pytest-playwright
        continue-on-error: true

      - name: Install Playwright browsers
        run: |
          npx playwright install --with-deps ${{ matrix.browser }} || python -m playwright install --with-deps ${{ matrix.browser }}
        continue-on-error: true

      - name: Verify Playwright installation
        run: |
          echo "Checking Playwright installation..."
          npx playwright --version || python -m playwright --version || echo "Playwright not installed"

      - name: Run Playwright Tests (Headless)
        if: matrix.mode == 'headless'
        run: |
          if [ -f "playwright.config.ts" ] || [ -f "playwright.config.js" ]; then
            npx playwright test --browser=${{ matrix.browser }}
          elif [ -d "tests" ] && find tests -name "*test*.py" -o -name "*_test.py" | grep -q .; then
            pytest tests/ --browser ${{ matrix.browser }} --headed=false
          else
            echo "No Playwright tests found - this is OK if not a web project"
          fi
        env:
          CI: true
        continue-on-error: true

      - name: Run Playwright Tests (Headed)
        if: matrix.mode == 'headed'
        run: |
          if [ -f "playwright.config.ts" ] || [ -f "playwright.config.js" ]; then
            npx playwright test --browser=${{ matrix.browser }} --headed
          elif [ -d "tests" ] && find tests -name "*test*.py" -o -name "*_test.py" | grep -q .; then
            pytest tests/ --browser ${{ matrix.browser }} --headed=true
          else
            echo "No Playwright tests found - this is OK if not a web project"
          fi
        env:
          CI: true
          DISPLAY: :99
        continue-on-error: true

      - name: Upload Playwright Test Results
        uses: actions/upload-artifact@main
        if: always()
        with:
          name: playwright-results-${{ matrix.browser }}-${{ matrix.mode }}
          path: |
            playwright-report/
            test-results/
            playwright-traces/
          retention-days: 30
        continue-on-error: true

      - name: Upload Playwright Screenshots on Failure
        uses: actions/upload-artifact@main
        if: failure()
        with:
          name: playwright-screenshots-${{ matrix.browser }}-${{ matrix.mode }}
          path: |
            screenshots/
            test-results/**/screenshots/
          retention-days: 7
        continue-on-error: true

  test-coverage-review:
    runs-on: ubuntu-latest
    needs: test-review-and-execution
    steps:
      - name: Checkout code
        uses: actions/checkout@main

      - name: Analyze Test Coverage
        id: coverage
        run: |
          echo "## Test Coverage Analysis" > /tmp/test-analysis.md
          echo "" >> /tmp/test-analysis.md
          
          # Find test files
          echo "### Test Files Found:" >> /tmp/test-analysis.md
          find . -type f \( -name "*test*.js" -o -name "*test*.ts" -o -name "*test*.py" -o -name "*spec*.js" -o -name "*spec*.ts" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/dist/*" \
            ! -path "*/.venv/*" \
            -exec echo "- {}" \; >> /tmp/test-analysis.md || echo "No test files found" >> /tmp/test-analysis.md
          
          echo "" >> /tmp/test-analysis.md
          echo "### Source Files Without Tests:" >> /tmp/test-analysis.md
          
          # Find source files that might need tests
          for file in $(find . -type f \( -name "*.js" -o -name "*.ts" -o -name "*.py" \) \
            ! -path "*/node_modules/*" \
            ! -path "*/dist/*" \
            ! -path "*/build/*" \
            ! -path "*/.venv/*" \
            ! -path "*/vendor/*" \
            ! -name "*test*" \
            ! -name "*spec*"); do
            basename=$(basename "$file" | sed 's/\.[^.]*$//')
            
            # Check if corresponding test file exists
            if ! find . -name "*${basename}*test*" -o -name "*${basename}*spec*" 2>/dev/null | grep -q .; then
              echo "- $file (no corresponding test found)" >> /tmp/test-analysis.md
            fi
          done
          
          cat /tmp/test-analysis.md

      - name: Test Review with Analysis Tools
        run: |
          echo "ðŸ§ª Performing comprehensive test suite review..."
          echo "==============================================="
          
          # 1. Playwright Test Analysis
          echo "ðŸŽ­ Playwright Test Analysis"
          echo "---------------------------"
          
          # Check for Playwright tests
          playwright_tests=$(find . -name "*.spec.js" -o -name "*.spec.ts" -o -name "*playwright*" | wc -l)
          echo "Playwright test files found: $playwright_tests"
          
          if [ "$playwright_tests" -gt 0 ]; then
            echo "Playwright test files:"
            find . -name "*.spec.js" -o -name "*.spec.ts" -o -name "*playwright*" | head -10
          else
            echo "âš ï¸ No Playwright tests found"
          fi
          
          # Check for Playwright configuration
          if [ -f "playwright.config.js" ] || [ -f "playwright.config.ts" ]; then
            echo "âœ… Playwright configuration found"
          else
            echo "âŒ Playwright configuration missing"
          fi
          
          # 2. Web-based Functionality Coverage
          echo ""
          echo "ðŸŒ Web-based Functionality Coverage"
          echo "-----------------------------------"
          
          # Check for web-related code that should have tests
          echo "Web endpoints and routes:"
          web_routes=$(grep -r "@app\.route\|@route\|app\.get\|app\.post" --include="*.py" . | wc -l)
          echo "Web routes found: $web_routes"
          
          # Check for frontend components
          frontend_files=$(find . -name "*.html" -o -name "*.js" -o -name "*.ts" -o -name "*.vue" -o -name "*.react" | wc -l)
          echo "Frontend files found: $frontend_files"
          
          if [ "$web_routes" -gt 0 ] && [ "$playwright_tests" -eq 0 ]; then
            echo "âš ï¸ Web routes found but no Playwright tests - consider adding E2E tests"
          fi
          
          # 3. Test Coverage Analysis
          echo ""
          echo "ðŸ“Š Test Coverage Analysis"
          echo "-------------------------"
          
          # Count all test files
          python_tests=$(find . -name "test_*.py" -o -name "*_test.py" | wc -l)
          js_tests=$(find . -name "*.test.js" -o -name "*.spec.js" | wc -l)
          ts_tests=$(find . -name "*.test.ts" -o -name "*.spec.ts" | wc -l)
          
          echo "Python test files: $python_tests"
          echo "JavaScript test files: $js_tests"
          echo "TypeScript test files: $ts_tests"
          echo "Total test files: $((python_tests + js_tests + ts_tests))"
          
          # Run test coverage if pytest is available
          if command -v pytest &> /dev/null; then
            echo ""
            echo "Running Python test coverage analysis..."
            pytest --cov=python_framework --cov=lib --cov-report=term-missing --tb=no -q || echo "Test coverage analysis completed with warnings"
          fi
          
          # 4. Test Quality and Maintainability
          echo ""
          echo "ðŸ” Test Quality and Maintainability"
          echo "-----------------------------------"
          
          # Check for test organization
          echo "Test organization:"
          test_dirs=$(find . -type d -name "*test*" | wc -l)
          echo "Test directories: $test_dirs"
          
          # Check for proper test structure
          echo ""
          echo "Test structure analysis:"
          if [ -d "test" ] || [ -d "tests" ]; then
            echo "âœ… Dedicated test directory found"
          else
            echo "âš ï¸ No dedicated test directory found"
          fi
          
          # Check for test utilities
          test_utils=$(find . -name "conftest.py" -o -name "test_utils.py" -o -name "fixtures.py" | wc -l)
          echo "Test utility files: $test_utils"
          
          # 5. Test Best Practices
          echo ""
          echo "âœ¨ Test Best Practices Analysis"
          echo "------------------------------"
          
          # Check for proper assertions
          echo "Assertion patterns:"
          assert_count=$(grep -r "assert\|assertEqual\|assertTrue\|expect(" --include="*.py" --include="*.js" --include="*.ts" test/ 2>/dev/null | wc -l || echo "0")
          echo "Assertion statements found: $assert_count"
          
          # Check for test isolation (setup/teardown)
          echo ""
          echo "Test isolation patterns:"
          setup_count=$(grep -r "setUp\|tearDown\|beforeEach\|afterEach\|fixture" --include="*.py" --include="*.js" --include="*.ts" test/ 2>/dev/null | wc -l || echo "0")
          echo "Setup/teardown patterns: $setup_count"
          
          # Check for mocking
          echo ""
          echo "Mocking patterns:"
          mock_count=$(grep -r "mock\|Mock\|stub\|spy" --include="*.py" --include="*.js" --include="*.ts" test/ 2>/dev/null | wc -l || echo "0")
          echo "Mock/stub usage: $mock_count"
          
          # 6. Flaky Test Detection
          echo ""
          echo "ðŸ”„ Flaky Test Detection"
          echo "----------------------"
          
          # Check for timing-related issues
          echo "Potential timing issues:"
          timing_issues=$(grep -r "sleep\|wait\|timeout\|delay" --include="*.py" --include="*.js" --include="*.ts" test/ 2>/dev/null | wc -l || echo "0")
          echo "Timing-related code in tests: $timing_issues"
          
          # Check for hardcoded waits
          hardcoded_waits=$(grep -r "time\.sleep\|setTimeout\|Thread\.sleep" --include="*.py" --include="*.js" --include="*.ts" test/ 2>/dev/null | wc -l || echo "0")
          echo "Hardcoded waits (potential flakiness): $hardcoded_waits"
          
          # 7. CI/CD Pipeline Integration
          echo ""
          echo "ðŸš€ CI/CD Pipeline Integration"
          echo "-----------------------------"
          
          # Check for test execution in workflows
          echo "Test execution in CI/CD:"
          if grep -r "pytest\|npm test\|yarn test" .github/workflows/ 2>/dev/null; then
            echo "âœ… Tests are integrated in CI/CD pipeline"
          else
            echo "âš ï¸ No test execution found in CI/CD workflows"
          fi
          
          # Check for Playwright in CI
          if grep -r "playwright" .github/workflows/ 2>/dev/null; then
            echo "âœ… Playwright tests integrated in CI/CD"
          else
            echo "âŒ Playwright tests not integrated in CI/CD"
          fi
          
          echo ""
          echo "ðŸ“‹ Test Review Recommendations:"
          echo "------------------------------"
          echo "1. Web Functionality Testing:"
          if [ "$web_routes" -gt 0 ] && [ "$playwright_tests" -eq 0 ]; then
            echo "   - Add Playwright tests for web routes and UI components"
            echo "   - Implement both headed and headless test modes"
          else
            echo "   - âœ… Web testing strategy appears adequate"
          fi
          
          echo ""
          echo "2. Test Coverage:"
          echo "   - Aim for >80% code coverage on critical paths"
          echo "   - Add integration tests for API endpoints"
          echo "   - Include edge case testing"
          
          echo ""
          echo "3. Test Quality:"
          echo "   - Ensure tests are isolated and independent"
          echo "   - Use descriptive test names and clear assertions"
          echo "   - Implement proper setup/teardown procedures"
          
          echo ""
          echo "4. Flaky Test Prevention:"
          echo "   - Replace hardcoded waits with proper wait conditions"
          echo "   - Use Playwright's built-in waiting mechanisms"
          echo "   - Implement retry logic for network-dependent tests"
          
          echo ""
          echo "5. CI/CD Integration:"
          echo "   - Ensure all tests run in CI/CD pipeline"
          echo "   - Add test result reporting and coverage metrics"
          echo "   - Configure parallel test execution for faster feedback"
          
          echo ""
          echo "ðŸŽ¯ Migration Recommendations:"
          echo "----------------------------"
          if [ "$frontend_files" -gt 0 ] && [ "$playwright_tests" -eq 0 ]; then
            echo "- Migrate existing web tests to Playwright for better reliability"
            echo "- Implement visual regression testing with Playwright"
            echo "- Add cross-browser testing capabilities"
          fi
          
          echo ""
          echo "âœ… Test review complete."
        continue-on-error: true

      - name: Create or Update Test Review Issue
        uses: actions/github-script@main
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const analysis = fs.readFileSync('/tmp/test-analysis.md', 'utf8');
            
            const date = new Date().toISOString().split('T')[0];
            const title = `Test Coverage Review - ${date}`;
            
            const body = `# Comprehensive Test Review
            
            This automated review ensures proper test coverage with Playwright for web tests.
            
            ${analysis}
            
            ## Playwright Test Status
            
            âœ… Tests run in multiple browsers: Chromium, Firefox, WebKit
            âœ… Tests run in both headed and headless modes
            
            ## Recommendations
            
            1. **Add Playwright tests** for all web-based functionality
            2. **Migrate existing web tests** to Playwright if not already using it
            3. **Add tests** for source files without coverage
            4. **Review test quality** and maintainability
            5. **Fix flaky tests** and timing issues
            6. **Ensure CI/CD integration** for all tests
            
            ## Action Items
            
            - [ ] Review files without tests and add coverage
            - [ ] Migrate non-Playwright web tests to Playwright
            - [ ] Fix any failing tests
            - [ ] Add documentation for test setup and execution
            
            ---
            *This issue was automatically generated by the Test Review workflow.*
            `;
            
            // Check if similar issue exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['test-coverage', 'automated'],
              per_page: 10
            });
            
            const recentIssue = issues.data.find(issue => {
              const createdAt = new Date(issue.created_at);
              const daysSinceCreation = (Date.now() - createdAt) / (1000 * 60 * 60 * 24);
              return daysSinceCreation < 7;
            });
            
            if (recentIssue) {
              console.log(`Recent issue found: #${recentIssue.number}, updating`);
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: recentIssue.number,
                body: `## Updated Analysis (${date})\n\n${analysis}`
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['test-coverage', 'automated', 'playwright', 'needs-review']
              });
            }
