#!/usr/bin/env python3
# -*- coding: utf-8 -*-

##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

import sys
import os
import argparse

# Add the lib directory to the path
script_path = os.path.abspath(__file__)
while os.path.islink(script_path):
    script_path = os.path.abspath(os.path.join(os.path.dirname(script_path), os.readlink(script_path)))
lib_path = os.path.join(os.path.dirname(script_path), '..', '..', 'lib')
sys.path.insert(0, os.path.abspath(lib_path))

try:
    from rex.text import Text
except ImportError:
    print("[!] Error: Could not import rex.text module", file=sys.stderr)
    print("[!] Make sure lib/rex/text.py exists", file=sys.stderr)
    sys.exit(1)


def parse_args():
    """Parse command line arguments"""
    parser = argparse.ArgumentParser(
        description='Create a cyclic pattern',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog=f'Example: {sys.argv[0]} -l 50 -s ABC,def,123\nAd1Ad2Ad3Ae1Ae2Ae3Af1Af2Af3Bd1Bd2Bd3Be1Be2Be3Bf1Bf'
    )
    
    parser.add_argument('-l', '--length',
                        type=int,
                        required=True,
                        help='The length of the pattern')
    
    parser.add_argument('-s', '--sets',
                        type=str,
                        help='Custom Pattern Sets (comma-separated)')
    
    return parser.parse_args()


def main():
    """Main function"""
    try:
        args = parse_args()
        
        # Parse custom sets if provided
        sets = None
        if args.sets:
            sets = args.sets.split(',')
        
        # Create and print the pattern
        pattern = Text.pattern_create(args.length, sets)
        print(pattern)
        
    except KeyboardInterrupt:
        print("\nAborted!", file=sys.stderr)
        sys.exit(1)
    except Exception as e:
        print(f"[x] {type(e).__name__}: {e}", file=sys.stderr)
        print("[*] If necessary, please refer to framework.log for more details.", file=sys.stderr)
        sys.exit(1)


if __name__ == '__main__':
    main()
