#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Moodle Teacher Enrollment Privilege Escalation to RCE

Moodle version 3.9, 3.8 to 3.8.3, 3.7 to 3.7.6, 3.5 to 3.5.12 and earlier unsupported versions
allow for a teacher to exploit chain to RCE.  A bug in the privileges system allows a teacher
to add themselves as a manager to their own class. They can then add any other users, and thus
look to add someone with manager privileges on the system (not just the class).  After
adding a system manager, a 'loginas' feature is used to access their account.  Next the system
is reconfigured to allow for all users to install an addon/plugin.  Then a malicious theme
is uploaded and creates an RCE.

If all of that is a success, we revert permissions for managers to system default and
remove our malicoius theme.  Manual cleanup to remove students from the class is required.

This module was tested against Moodle version 3.9
"""

import logging
import sys
import os

# Add lib path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../../../../lib'))

from metasploit import module
from msf.http_client import HTTPClient, CheckCode

metadata = {
    'name': 'Moodle Teacher Enrollment Privilege Escalation to RCE',
    'description': '''
        Moodle version 3.9, 3.8 to 3.8.3, 3.7 to 3.7.6, 3.5 to 3.5.12 and earlier unsupported versions
        allow for a teacher to exploit chain to RCE.  A bug in the privileges system allows a teacher
        to add themselves as a manager to their own class. They can then add any other users, and thus
        look to add someone with manager privileges on the system (not just the class).  After
        adding a system manager, a 'loginas' feature is used to access their account.  Next the system
        is reconfigured to allow for all users to install an addon/plugin.  Then a malicious theme
        is uploaded and creates an RCE.
        
        If all of that is a success, we revert permissions for managers to system default and
        remove our malicoius theme.  Manual cleanup to remove students from the class is required.
        
        This module was tested against Moodle version 3.9
    ''',
    'authors': [
        'HoangKien1020',
        'lanz',
        'h00die',
    ],
    'date': '2020-07-20',
    'license': 'MSF_LICENSE',
    'type': 'remote_exploit',  # TODO: Adjust type
    'targets': [
        {'name': 'Automatic'},  # TODO: Add platform/arch
    ],
    'options': {
        'rhost': {'type': 'address', 'description': 'Target address', 'required': True},
        'rport': {'type': 'port', 'description': 'Target port', 'required': True, 'default': 80},
        # TODO: Add module-specific options
    },
    'notes': {
        'stability': ['CRASH_SAFE'],  # TODO: Adjust
        'reliability': ['REPEATABLE_SESSION'],  # TODO: Adjust
        'side_effects': ['IOC_IN_LOGS']  # TODO: Adjust
    }
}


def run(args):
    '''Module entry point.'''
    module.LogHandler.setup(msg_prefix=f"{args['rhost']}:{args['rport']} - ")
    
    rhost = args['rhost']
    rport = args['rport']
    
    logging.info('Starting module execution...')
    
    # TODO: Implement module logic
    # 1. Create HTTP client or TCP socket
    # 2. Check if target is vulnerable
    # 3. Exploit the vulnerability
    # 4. Handle success/failure
    
    try:
        client = HTTPClient(rhost=rhost, rport=rport)
        
        # Your exploit code here
        response = client.get('/')
        if response:
            logging.info(f'Response status: {response.status_code}')
        
        client.close()
        
    except Exception as e:
        logging.error(f'Exploitation failed: {e}')
        return
    
    logging.info('Module execution complete')


if __name__ == '__main__':
    module.run(metadata, run)
