#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
Nagios XI Prior to 5.6.6 getprofile.sh Authenticated Remote Command Execution

This module exploits a vulnerability in the getprofile.sh script
of Nagios XI prior to 5.6.6 in order to upload a malicious check_ping
plugin and thereby execute arbitrary commands.

For Nagios XI 5.2.0-5.4.13, the commands are run as the nagios user.
For versions 5.5.0-5.6.5 the commands are run as root. Note that versions
prior to 5.2.0 will still be marked as being vulnerable however this
module does not presently support exploiting these targets.

The module uploads a malicious check_ping plugin to the Nagios XI server via
/admin/monitoringplugins.php and then executes this plugin by issuing
a HTTP GET request to download a system profile from the server.
For all supported targets except Linux (cmd), the module uses a command
stager to write the exploit to the target via the malicious plugin.
This may not work if Nagios XI is running in a restricted Unix environment,
so in that case the target must be set to Linux (cmd). The module then
writes the payload to the malicious plugin while avoiding commands
that may not be supported.

Valid credentials for a user with administrative privileges are
required. This module was successfully tested on Nagios XI 5.3.0 and
Nagios 5.6.5, both running on CentOS 7. For vulnerable versions before
5.5.0, it may take a significant amount of time for the payload to get
back (up to 5 minutes). If exploitation fails against an older system,
it is recommended to increase the WfsDelay setting (default is 300
seconds). See the documentation for more information.
"""

import logging
import sys
import os

# Add lib path
sys.path.insert(0, os.path.join(os.path.dirname(__file__), '../../../../lib'))

from metasploit import module
from msf.http_client import HTTPClient, CheckCode

metadata = {
    'name': 'Nagios XI Prior to 5.6.6 getprofile.sh Authenticated Remote Command Execution',
    'description': '''
        This module exploits a vulnerability in the getprofile.sh script
        of Nagios XI prior to 5.6.6 in order to upload a malicious check_ping
        plugin and thereby execute arbitrary commands.
        
        For Nagios XI 5.2.0-5.4.13, the commands are run as the nagios user.
        For versions 5.5.0-5.6.5 the commands are run as root. Note that versions
        prior to 5.2.0 will still be marked as being vulnerable however this
        module does not presently support exploiting these targets.
        
        The module uploads a malicious check_ping plugin to the Nagios XI server via
        /admin/monitoringplugins.php and then executes this plugin by issuing
        a HTTP GET request to download a system profile from the server.
        For all supported targets except Linux (cmd), the module uses a command
        stager to write the exploit to the target via the malicious plugin.
        This may not work if Nagios XI is running in a restricted Unix environment,
        so in that case the target must be set to Linux (cmd). The module then
        writes the payload to the malicious plugin while avoiding commands
        that may not be supported.
        
        Valid credentials for a user with administrative privileges are
        required. This module was successfully tested on Nagios XI 5.3.0 and
        Nagios 5.6.5, both running on CentOS 7. For vulnerable versions before
        5.5.0, it may take a significant amount of time for the payload to get
        back (up to 5 minutes). If exploitation fails against an older system,
        it is recommended to increase the WfsDelay setting (default is 300
        seconds). See the documentation for more information.
    ''',
    'authors': [
        'Jak Gibb',
        'Erik Wynter',
    ],
    'date': '2019-07-29',
    'license': 'MSF_LICENSE',
    'type': 'remote_exploit',  # TODO: Adjust type
    'targets': [
        {'name': 'Linux (x86)'},  # TODO: Add platform/arch
    ],
    'options': {
        'rhost': {'type': 'address', 'description': 'Target address', 'required': True},
        'rport': {'type': 'port', 'description': 'Target port', 'required': True, 'default': 80},
        # TODO: Add module-specific options
    },
    'notes': {
        'stability': ['CRASH_SAFE'],  # TODO: Adjust
        'reliability': ['REPEATABLE_SESSION'],  # TODO: Adjust
        'side_effects': ['IOC_IN_LOGS']  # TODO: Adjust
    }
}


def run(args):
    '''Module entry point.'''
    module.LogHandler.setup(msg_prefix=f"{args['rhost']}:{args['rport']} - ")
    
    rhost = args['rhost']
    rport = args['rport']
    
    logging.info('Starting module execution...')
    
    # TODO: Implement module logic
    # 1. Create HTTP client or TCP socket
    # 2. Check if target is vulnerable
    # 3. Exploit the vulnerability
    # 4. Handle success/failure
    
    try:
        client = HTTPClient(rhost=rhost, rport=rport)
        
        # Your exploit code here
        response = client.get('/')
        if response:
            logging.info(f'Response status: {response.status_code}')
        
        client.close()
        
    except Exception as e:
        logging.error(f'Exploitation failed: {e}')
        return
    
    logging.info('Module execution complete')


if __name__ == '__main__':
    module.run(metadata, run)
