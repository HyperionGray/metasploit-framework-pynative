##
# This module requires Metasploit: https://metasploit.com/download
# Current source: https://github.com/rapid7/metasploit-framework
##

module MetasploitModule

  CachedSize = 1024

  include Msf::Payload::Single
  include Msf::Payload::Multi

  def initialize(info = {})
    super(
      merge_info(
        info,
        'Name' => 'Multi-Platform Malware Simulation Dropper',
        'Description' => %q{
          This payload creates a self-contained malware simulation dropper
          that can be uploaded to target systems. The dropper includes
          time bomb functionality and automatically cleans up after a
          configurable duration. It simulates various malware behaviors
          safely for penetration testing purposes.
        },
        'Author' => ['Metasploit Framework Team'],
        'License' => MSF_LICENSE,
        'Platform' => %w[win unix linux osx],
        'Arch' => ARCH_CMD,
        'Handler' => Msf::Handler::None,
        'Session' => Msf::Sessions::CommandShell,
        'PayloadType' => 'cmd',
        'RequiredCmd' => 'generic',
        'Payload' => {
          'Offsets' => {},
          'Payload' => ''
        }
      )
    )

    register_options([
      OptInt.new('DURATION', [true, 'Duration in seconds before auto-cleanup', 300]),
      OptString.new('MALWARE_TYPE', [true, 'Type of malware to simulate', 'persistence']),
      OptBool.new('SIMULATE_ONLY', [true, 'Only simulate without actual persistence', true]),
      OptString.new('OUTPUT_FILE', [false, 'Output filename for the dropper', '']),
    ])
  end

  def generate(_opts = {})
    duration = datastore['DURATION']
    malware_type = datastore['MALWARE_TYPE']
    simulate_only = datastore['SIMULATE_ONLY']
    
    # Generate platform-specific dropper
    case target_platform.names.first
    when 'win'
      generate_windows_dropper(duration, malware_type, simulate_only)
    when 'unix', 'linux'
      generate_unix_dropper(duration, malware_type, simulate_only)
    when 'osx'
      generate_osx_dropper(duration, malware_type, simulate_only)
    else
      generate_generic_dropper(duration, malware_type, simulate_only)
    end
  end

  private

  def generate_windows_dropper(duration, malware_type, simulate_only)
    dropper_content = <<~EOF
      @echo off
      REM Metasploit Malware Simulation Dropper
      REM This is NOT real malware - penetration testing simulation only
      REM Created: #{Time.now}
      REM Duration: #{duration} seconds
      REM Type: #{malware_type}
      REM Simulate Only: #{simulate_only}
      
      echo ========================================
      echo MALWARE SIMULATION - PENETRATION TEST
      echo ========================================
      echo This is a HARMLESS simulation
      echo Duration: #{duration} seconds
      echo Type: #{malware_type}
      echo ========================================
      
      REM Create simulation directory
      set SIM_DIR=%TEMP%\\malware_sim_%RANDOM%
      mkdir "%SIM_DIR%" 2>nul
      
      REM Create time bomb script
      echo @echo off > "%SIM_DIR%\\time_bomb.bat"
      echo timeout /t #{duration} /nobreak ^>nul >> "%SIM_DIR%\\time_bomb.bat"
      echo echo Time bomb expired - cleaning up... >> "%SIM_DIR%\\time_bomb.bat"
      echo rmdir /s /q "%SIM_DIR%" >> "%SIM_DIR%\\time_bomb.bat"
      echo exit >> "%SIM_DIR%\\time_bomb.bat"
      
      REM Start time bomb in background
      start /b "%SIM_DIR%\\time_bomb.bat"
      
      REM Simulate malware behavior based on type
      if /i "%1"=="persistence" goto :simulate_persistence
      if /i "%1"=="rootkit" goto :simulate_rootkit
      if /i "%1"=="stealer" goto :simulate_stealer
      goto :simulate_generic
      
      :simulate_persistence
      echo Simulating persistence mechanisms...
      #{generate_windows_persistence_simulation(simulate_only)}
      goto :end
      
      :simulate_rootkit
      echo Simulating rootkit behavior...
      #{generate_windows_rootkit_simulation(simulate_only)}
      goto :end
      
      :simulate_stealer
      echo Simulating data stealing...
      #{generate_windows_stealer_simulation(simulate_only)}
      goto :end
      
      :simulate_generic
      echo Simulating generic malware behavior...
      #{generate_windows_generic_simulation(simulate_only)}
      
      :end
      echo Malware simulation complete
      echo Will auto-cleanup in #{duration} seconds
      exit /b 0
    EOF
    
    dropper_content
  end

  def generate_unix_dropper(duration, malware_type, simulate_only)
    dropper_content = <<~EOF
      #!/bin/bash
      # Metasploit Malware Simulation Dropper
      # This is NOT real malware - penetration testing simulation only
      # Created: #{Time.now}
      # Duration: #{duration} seconds
      # Type: #{malware_type}
      # Simulate Only: #{simulate_only}
      
      echo "========================================"
      echo "MALWARE SIMULATION - PENETRATION TEST"
      echo "========================================"
      echo "This is a HARMLESS simulation"
      echo "Duration: #{duration} seconds"
      echo "Type: #{malware_type}"
      echo "========================================"
      
      # Create simulation directory
      SIM_DIR="/tmp/malware_sim_$$"
      mkdir -p "$SIM_DIR"
      chmod 700 "$SIM_DIR"
      
      # Create time bomb script
      cat > "$SIM_DIR/time_bomb.sh" << 'BOMB_EOF'
      #!/bin/bash
      sleep #{duration}
      echo "Time bomb expired - cleaning up..."
      rm -rf "$SIM_DIR"
      exit 0
      BOMB_EOF
      
      chmod +x "$SIM_DIR/time_bomb.sh"
      
      # Start time bomb in background
      nohup "$SIM_DIR/time_bomb.sh" >/dev/null 2>&1 &
      
      # Simulate malware behavior based on type
      case "#{malware_type}" in
        "persistence")
          echo "Simulating persistence mechanisms..."
          #{generate_unix_persistence_simulation(simulate_only)}
          ;;
        "rootkit")
          echo "Simulating rootkit behavior..."
          #{generate_unix_rootkit_simulation(simulate_only)}
          ;;
        "stealer")
          echo "Simulating data stealing..."
          #{generate_unix_stealer_simulation(simulate_only)}
          ;;
        *)
          echo "Simulating generic malware behavior..."
          #{generate_unix_generic_simulation(simulate_only)}
          ;;
      esac
      
      echo "Malware simulation complete"
      echo "Will auto-cleanup in #{duration} seconds"
      exit 0
    EOF
    
    dropper_content
  end

  def generate_osx_dropper(duration, malware_type, simulate_only)
    # macOS version is similar to Unix but with some macOS-specific elements
    generate_unix_dropper(duration, malware_type, simulate_only).gsub(
      'MALWARE SIMULATION - PENETRATION TEST',
      'MALWARE SIMULATION - PENETRATION TEST (macOS)'
    )
  end

  def generate_generic_dropper(duration, malware_type, simulate_only)
    # Generic version that works on most platforms
    generate_unix_dropper(duration, malware_type, simulate_only)
  end

  # Windows simulation methods
  def generate_windows_persistence_simulation(simulate_only)
    if simulate_only
      <<~EOF
        echo SIMULATION: Would create registry run key
        echo SIMULATION: Would create scheduled task
        echo SIMULATION: Would create service
      EOF
    else
      <<~EOF
        echo Creating fake registry entry...
        reg add "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" /v "SystemUpdate" /d "%SIM_DIR%\\fake_malware.exe" /f >nul 2>&1
        echo Creating fake executable...
        echo @echo off > "%SIM_DIR%\\fake_malware.exe"
        echo echo Fake malware running... >> "%SIM_DIR%\\fake_malware.exe"
      EOF
    end
  end

  def generate_windows_rootkit_simulation(simulate_only)
    if simulate_only
      <<~EOF
        echo SIMULATION: Would hook system calls
        echo SIMULATION: Would hide processes
        echo SIMULATION: Would hide files
      EOF
    else
      <<~EOF
        echo Creating fake system files...
        echo Fake rootkit > "%SIM_DIR%\\system32.dll"
        echo Creating fake process...
        echo @echo off > "%SIM_DIR%\\svchost_fake.exe"
      EOF
    end
  end

  def generate_windows_stealer_simulation(simulate_only)
    if simulate_only
      <<~EOF
        echo SIMULATION: Would steal browser passwords
        echo SIMULATION: Would collect system information
        echo SIMULATION: Would exfiltrate data
      EOF
    else
      <<~EOF
        echo Collecting fake system info...
        systeminfo > "%SIM_DIR%\\system_info.txt" 2>nul
        echo Fake stolen data > "%SIM_DIR%\\stolen_data.txt"
      EOF
    end
  end

  def generate_windows_generic_simulation(simulate_only)
    <<~EOF
      echo Simulating malware initialization...
      timeout /t 2 /nobreak >nul
      echo Simulating C2 communication...
      timeout /t 2 /nobreak >nul
      echo Simulating data collection...
      timeout /t 2 /nobreak >nul
    EOF
  end

  # Unix simulation methods
  def generate_unix_persistence_simulation(simulate_only)
    if simulate_only
      <<~EOF
        echo "SIMULATION: Would create crontab entry"
        echo "SIMULATION: Would create init script"
        echo "SIMULATION: Would modify shell profiles"
      EOF
    else
      <<~EOF
        echo "Creating fake crontab entry..."
        (crontab -l 2>/dev/null; echo "*/5 * * * * $SIM_DIR/fake_malware.sh") | crontab - 2>/dev/null
        echo "Creating fake malware script..."
        echo '#!/bin/bash' > "$SIM_DIR/fake_malware.sh"
        echo 'echo "Fake malware running..."' >> "$SIM_DIR/fake_malware.sh"
        chmod +x "$SIM_DIR/fake_malware.sh"
      EOF
    end
  end

  def generate_unix_rootkit_simulation(simulate_only)
    if simulate_only
      <<~EOF
        echo "SIMULATION: Would replace system binaries"
        echo "SIMULATION: Would hide processes"
        echo "SIMULATION: Would hide network connections"
      EOF
    else
      <<~EOF
        echo "Creating fake system binaries..."
        echo '#!/bin/bash' > "$SIM_DIR/fake_ps"
        echo '/bin/ps "$@" | grep -v fake_malware' >> "$SIM_DIR/fake_ps"
        chmod +x "$SIM_DIR/fake_ps"
      EOF
    end
  end

  def generate_unix_stealer_simulation(simulate_only)
    if simulate_only
      <<~EOF
        echo "SIMULATION: Would collect SSH keys"
        echo "SIMULATION: Would steal browser data"
        echo "SIMULATION: Would harvest credentials"
      EOF
    else
      <<~EOF
        echo "Collecting fake system info..."
        uname -a > "$SIM_DIR/system_info.txt" 2>/dev/null
        echo "Fake stolen data" > "$SIM_DIR/stolen_data.txt"
      EOF
    end
  end

  def generate_unix_generic_simulation(simulate_only)
    <<~EOF
      echo "Simulating malware initialization..."
      sleep 2
      echo "Simulating C2 communication..."
      sleep 2
      echo "Simulating data collection..."
      sleep 2
    EOF
  end

end